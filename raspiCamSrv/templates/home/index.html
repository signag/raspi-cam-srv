<!--
RaspiCamSrv's Live page    
-->
{% extends 'base.html' %}

{% block header %}
    {% block title %}Live{% endblock %}
{% endblock %}

{% block content %}
    <div class="w3-row w3-border">
        <!-- First row -->
        <div class="w3-half" style="min-height: 440px;">
            <!-- Live stream -->
            {% if sc.isVideoRecording %}
            <img src="{{ url_for('static', filename='recordingvideo.jpg') }}" class="w3-image" id="liveviewimage">
            {% else %}
            <img src="{{ url_for('home.video_feed') }}" class="w3-image" id="liveviewimage">
            {% endif %}
        </div>
        {% if cp.hasFocus %}
        <div class="w3-half" onload="showAfWindows('{{ sc.lastLiveTab }}', 'include_afwindows', 'afwindows', '{{ sc.scalerCropLiveView }}')">
        {% else %}
        <div class="w3-half">
        {% endif %}
            <!-- Camara control sections 
                Settings changed here are applied to the camera while the live stream is active
            -->
            <div class="w3-bar w3-green">
                <!-- Controls menue -->
                {% if sc.lastLiveTab == "focus" %}
                <button class="w3-bar-item w3-button ctrlmenu w3-light-green" id="focusbtn" onclick="openCtrlTab('focus','focusbtn')">Focus</button>
                {% else %}
                <button class="w3-bar-item w3-button ctrlmenu" id="focusbtn" onclick="openCtrlTab('focus','focusbtn')">Focus</button>
                {% endif %}
                {% if sc.lastLiveTab == "zoom" %}
                <button class="w3-bar-item w3-button ctrlmenu w3-light-green" id="zoombtn" onclick="openCtrlTab('zoom','zoombtn')">Zoom</button>
                {% else %}
                <button class="w3-bar-item w3-button ctrlmenu" id="zoombtn" onclick="openCtrlTab('zoom','zoombtn')">Zoom</button>
                {% endif %}
                {% if sc.lastLiveTab == "autoexposure" %}
                <button class="w3-bar-item w3-button ctrlmenu w3-light-green" id="aebtn" onclick="openCtrlTab('autoexposure','aebtn')">Auto-Exposure</button>
                {% else %}
                <button class="w3-bar-item w3-button ctrlmenu" id="aebtn" onclick="openCtrlTab('autoexposure','aebtn')">Auto-Exposure</button>
                {% endif %}
                {% if sc.lastLiveTab == "exposure" %}
                <button class="w3-bar-item w3-button ctrlmenu w3-light-green" id="expbtn" onclick="openCtrlTab('exposure','expbtn')">Exposure</button>
                {% else %}
                <button class="w3-bar-item w3-button ctrlmenu" id="expbtn" onclick="openCtrlTab('exposure','expbtn')">Exposure</button>
                {% endif %}
                {% if sc.lastLiveTab == "image" %}
                <button class="w3-bar-item w3-button ctrlmenu w3-light-green" id="imagebtn" onclick="openCtrlTab('image','imagebtn')">Image</button>
                {% else %}
                <button class="w3-bar-item w3-button ctrlmenu" id="imagebtn" onclick="openCtrlTab('image','imagebtn')">Image</button>
                {% endif %}
            </div>
            {% if sc.lastLiveTab == "focus" %}
            <div id="focus" class="w3-container controlgroup">
            {% else %}
            <div id="focus" class="w3-container controlgroup" style="display:none">
            {% endif %}
                <!-- Focus handling -->
                <h4>Focus handling</h4>
                {% if cp.hasFocus %}
                <div>
                    <form method="post" id="formfocuscontrol" action="{{ url_for('home.focus_control') }}">
                        <table class="w3-table-all">
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_afMode == True %}
                                    <input type="checkbox" id="include_afmode" name="include_afmode"
                                        onclick="includeCtrl('include_afmode', 'afmode')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_afmode" name="include_afmode"
                                        onclick="includeCtrl('include_afmode', 'afmode')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        The autofocus mode.
                                    </span>
                                    <label for="afmode">Autofocus Mode:</label>
                                </td>
                                <td>
                                    {% if cc.include_afMode == True %}
                                    <select name="afmode" id="afmode">
                                    {% else %}
                                    <select name="afmode" id="afmode" disabled>
                                    {% endif %}
                                        {% if cc.afMode == 0 %}
                                        <option value="0" selected>Manual</option>
                                        {% else %}
                                        <option value="0">Manual</option>
                                        {% endif %}
                                        {% if cc.afMode == 1 %}
                                        <option value="1" selected>Auto</option>
                                        {% else %}
                                        <option value="1">Auto</option>
                                        {% endif %}
                                        {% if cc.afMode == 2 %}
                                        <option value="2" selected>Continuous</option>
                                        {% else %}
                                        <option value="2">Continuous</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_lensPosition == True %}
                                    <input type="checkbox" id="include_lensposition" name="include_lensposition" 
                                        onclick="includeCtrl('include_lensposition', 'fdist')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_lensposition" name="include_lensposition" 
                                        onclick="includeCtrl('include_lensposition', 'fdist')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        The focal distance in m. <br>(pressing Enter will automatially submit)
                                    </span>
                                    <label for="fdist">Focal Distance [m]:</label>
                                </td>
                                <td>
                                    {% if cc.include_lensPosition == True %}
                                    <input type="number" id="fdist" name="fdist" min="0.001" max="999" step="0.001" value="{{ cc.focalDistance }}">
                                    {% else %}
                                    <input type="number" id="fdist" name="fdist" min="0.001" max="999" step="0.001" value="{{ cc.focalDistance }}" disabled>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_afMetering == True %}
                                    <input type="checkbox" id="include_afmetering" name="include_afmetering"
                                        onclick="includeCtrl('include_afmetering', 'afmetering')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_afmetering" name="include_afmetering"
                                        onclick="includeCtrl('include_afmetering', 'afmetering')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Specifies where focus should be measured.
                                    </span>
                                    <label for="afmetering">Autofocus Metering:</label>
                                </td>
                                <td>
                                    {% if cc.include_afMetering == True %}
                                    <select name="afmetering" id="afmetering">
                                    {% else %}
                                    <select name="afmetering" id="afmetering" disabled>
                                    {% endif %}
                                        {% if cc.afMetering == 0 %}
                                        <option value="0" selected>Auto</option>
                                        {% else %}
                                        <option value="0">Auto</option>
                                        {% endif %}
                                        {% if cc.afMetering == 1 %}
                                        <option value="1" selected>Windows</option>
                                        {% else %}
                                        <option value="1">Windows</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_afPause == True %}
                                    <input type="checkbox" id="include_afpause" name="include_afpause"
                                        onclick="includeCtrl('include_afpause', 'afpause')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_afpause" name="include_afpause"
                                        onclick="includeCtrl('include_afpause', 'afpause')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Pause continuous autofocus. Only has any effect when in continuous autofocus mode.
                                    </span>
                                    <label for="afpause">Autofocus Pause:</label>
                                </td>
                                <td>
                                    {% if cc.include_afPause == True %}
                                    <select name="afpause" id="afpause">
                                    {% else %}
                                    <select name="afpause" id="afpause" disabled>
                                    {% endif %}
                                        {% if cc.afPause == 0 %}
                                        <option value="0" selected>Immediate</option>
                                        {% else %}
                                        <option value="0">Immediate</option>
                                        {% endif %}
                                        {% if cc.afPause == 1 %}
                                        <option value="1" selected>Deferred</option>
                                        {% else %}
                                        <option value="1">Deferred</option>
                                        {% endif %}
                                        {% if cc.afPause == 2 %}
                                        <option value="2" selected>Resume</option>
                                        {% else %}
                                        <option value="2">Resume</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_afRange == True %}
                                    <input type="checkbox" id="include_afrange" name="include_afrange"
                                        onclick="includeCtrl('include_afrange', 'afrange')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_afrange" name="include_afrange"
                                        onclick="includeCtrl('include_afrange', 'afrange')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <label for="afrange">Autofocus Range:</label>
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Range of lens positions to search.
                                    </span>
                                </td>
                                <td>
                                    {% if cc.include_afRange == True %}
                                    <select name="afrange" id="afrange">
                                    {% else %}
                                    <select name="afrange" id="afrange" disabled>
                                    {% endif %}
                                        {% if cc.afRange == 0 %}
                                        <option value="0" selected>Normal</option>
                                        {% else %}
                                        <option value="0">Normal</option>
                                        {% endif %}
                                        {% if cc.afRange == 1 %}
                                        <option value="1" selected>Macro</option>
                                        {% else %}
                                        <option value="1">Macro</option>
                                        {% endif %}
                                        {% if cc.afRange == 2 %}
                                        <option value="2" selected>Full</option>
                                        {% else %}
                                        <option value="2">Full</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_afSpeed == True %}
                                    <input type="checkbox" id="include_afspeed" name="include_afspeed"
                                        onclick="includeCtrl('include_afspeed', 'afspeed')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_afspeed" name="include_afspeed"
                                        onclick="includeCtrl('include_afspeed', 'afspeed')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <label for="afspeed">Autofocus Speed:</label>
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Speed of the autofocus search.
                                    </span>
                                </td>
                                <td>
                                    {% if cc.include_afSpeed == True %}
                                    <select name="afspeed" id="afspeed">
                                    {% else %}
                                    <select name="afspeed" id="afspeed" disabled >
                                    {% endif %}
                                        {% if cc.afSpeed == 0 %}
                                        <option value="0" selected>Normal</option>
                                        {% else %}
                                        <option value="0">Normal</option>
                                        {% endif %}
                                        {% if cc.afSpeed == 1 %}
                                        <option value="1" selected>Fast</option>
                                        {% else %}
                                        <option value="1">Fast</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_afWindows == True %}
                                    <input type="checkbox" id="include_afwindows" onclick="drawAfWindow('include_afwindows', 'afwindows', '{{ sc.scalerCropLiveView }}')" name="include_afwindows"
                                        onclick="includeCtrl('include_afwindows', 'afwindows')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_afwindows" onclick="drawAfWindow('include_afwindows', 'afwindows', '{{ sc.scalerCropLiveView }}')" name="include_afwindows"
                                        onclick="includeCtrl('include_afwindows', 'afwindows')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <label for="afwindows">Autofocus Windows:</label>
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Location of the windows in the image to use to
                                        measure focus.<br>
                                        A list of rectangles (tuples of 4 numbers
                                        denoting x_offset, y_offset, width and
                                        height). The rectangle units refer to the
                                        maximum scaler crop window.
                                    </span>
                                </td>
                                <td>
                                    {% if cc.include_afWindows == True %}
                                    <input type="text" id="afwindows" name="afwindows" value="{{ cc.afWindowsStr }}" disabled>
                                    {% else %}
                                    <input type="text" id="afwindows" name="afwindows" value="{{ cc.afWindowsStr }}" disabled>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </form>
                    <p style="margin-bottom: 0; margin-top: 5px"></p>
                    <table>
                        <tr>
                            <td style="width: 50%">
                                <input class="w3-button w3-black" onclick="enableAfWindows()" form="formfocuscontrol" type="submit" value="Submit">
                            <td style="width: 50%">
                                <form method="post" action="{{ url_for('home.trigger_autofocus') }}">
                                    <input class="w3-button w3-black" type="submit" value="Trigger Autofocus">
                                </form>
                            </td>
                        </tr>
                    </table>
                </div>
                {% else %}
                <p>Not available for this camera</p>
                {% endif %}
            </div>
            {% if sc.lastLiveTab == "zoom" %}
            <div id="zoom" class="w3-container controlgroup">
            {% else %}
            <div id="zoom" class="w3-container controlgroup" style="display:none">
            {% endif %}
                <!-- Zoom & Pan -->
                <h4>Zoom and pan</h4>
                <div>
                    <form method="post" action="{{ url_for('home.set_zoom') }}">
                        <table class="w3-table-all">
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        The current zoom factor in %
                                    </span>
                                    <label for="zoomfactor">Current zoom factor in %:</label>
                                </td>
                                <td>
                                    <input type="number" id="zoomfactor" name="zoomfactor" value="{{ sc.zoomFactor }}" disabled>
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        The increment or decrement (in %) by which the zoom factor will be modified in each step
                                    </span>
                                    <label for="zoomfactorstep">Zoom & pan step in %:</label>
                                </td>
                                <td>
                                    <input type="number" id="zoomfactorstep" name="zoomfactorstep" value="{{ sc.zoomFactorStep }}" min="2" max="20">
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        The scaler crop rectangle determines which part of the image received from the sensor is
                                        cropped and then scaled to produce an output image of the correct size.
                                        This value refers to the maximum sensor resolution.<br>
                                        (x_offset, y_offset, width, height)
                                    </span>
                                    <label for="scalercrop">Current ScalerCrop (Zoom):</label>
                                </td>
                                <td>
                                    <input type="text" id="scalercrop" name="scalercrop" value="{{ cc.scalerCropStr }}" disabled>
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Scaler Crop for the live view from live view metadata. 
                                        May be different from value for Zoom due to Sensor Mode restrictions<br>
                                        (x_offset, y_offset, width, height)
                                    </span>
                                    <label for="scalercroplive">Current ScalerCrop (Live View):</label>
                                </td>
                                <td>
                                    <input type="text" id="scalercroplive" name="scalercroplive" value="{{ sc.scalerCropLiveViewStr }}" disabled>
                                </td>
                            </tr>
                        </table>
                        <input class="w3-button w3-black" style ="display:none" type="submit" value="Submit">
                    </form>
                    <p style="margin-bottom: 0; margin-top: 0"></p>
                    <table class="w3-table">
                        <tr>
                            <td>
                                <form method="post" action="{{ url_for('home.zoom_in') }}">
                                    <input class="w3-button w3-black" style="width:80%" type="submit" value="Zoom in">
                                </form>
                            </td>
                            <td>
                            </td>
                            <td>
                                <form method="post" action="{{ url_for('home.pan_up') }}">
                                    <input class="w3-button w3-black" style="width:80%" type="submit" value="Pan up">
                                </form>
                            </td>
                            <td>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <form method="post" action="{{ url_for('home.zoom_out') }}">
                                    <input class="w3-button w3-black" style="width:80%" type="submit" value="Zoom out">
                                </form>
                            </td>
                            <td>
                                <form method="post" action="{{ url_for('home.pan_left') }}">
                                    <input class="w3-button w3-black" style="width:80%" type="submit" value="Pan left">
                                </form>
                            </td>
                            <td>
                                <form method="post" action="{{ url_for('home.pan_center') }}">
                                    <input class="w3-button w3-black" style="width:80%" type="submit" value="Center">
                                </form>
                            </td>
                            <td>
                                <form method="post" action="{{ url_for('home.pan_right') }}">
                                    <input class="w3-button w3-black" style="width:80%" type="submit" value="Pan right">
                                </form>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <form method="post" action="{{ url_for('home.zoom_full') }}">
                                    <input class="w3-button w3-black" style="width:80%" type="submit" value="Full">
                                </form>
                            </td>
                            <td>
                            </td>
                            <td>
                                <form method="post" action="{{ url_for('home.pan_down') }}">
                                    <input class="w3-button w3-black" style="width:80%" type="submit" value="Pan down">
                                </form>
                            </td>
                            <td>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            {% if sc.lastLiveTab == "autoexposure" %}
            <div id="autoexposure" class="w3-container controlgroup">
            {% else %}
            <div id="autoexposure" class="w3-container controlgroup" style="display:none">
            {% endif %}
                <!-- Control settings for auto-exposure -->
                <h4>Auto Exposure</h4>
                <div>
                    <form method="post" action="{{ url_for('home.ae_control') }}">
                        <table class="w3-table-all">
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_aeEnable == True %}
                                    <input type="checkbox" id="include_aeenable" name="include_aeenable" 
                                        onclick="includeCtrl('include_aeenable', 'aeenable')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_aeenable" name="include_aeenable" 
                                        onclick="includeCtrl('include_aeenable', 'aeenable')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Enable or disable the Automatic Exposure (AE).
                                    </span>
                                    <label for="aeenable">AE enabled:</label>
                                </td>
                                <td>
                                    {% if cc.aeEnable == True %}
                                    {% if cc.include_aeEnable == True %}
                                    <input type="checkbox" id="aeenable" name="aeenable" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="aeenable" name="aeenable" value="1" checked disabled>
                                    {% endif %}
                                    {% else %}
                                    {% if cc.include_aeEnable == True%}
                                    <input type="checkbox" id="aeenable" name="aeenable" value="0">
                                    {% else %}
                                    <input type="checkbox" id="aeenable" name="aeenable" value="0" disabled>
                                    {% endif %}
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_aeMeteringMode == True %}
                                    <input type="checkbox" id="include_aemeteringmode" name="include_aemeteringmode" 
                                        onclick="includeCtrl('include_aemeteringmode', 'aemeteringmode')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_aemeteringmode" name="include_aemeteringmode" 
                                        onclick="includeCtrl('include_aemeteringmode', 'aemeteringmode')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Sets the metering mode of the algorithm for 
                                        automatic gain control (AGC) and automatic exposure control (AEC).
                                    </span>
                                    <label for="aemeteringmode">AEC/AGC Metering Mode:</label>
                                </td>
                                <td>
                                    {% if cc.include_aeMeteringMode == True %}
                                    <select name="aemeteringmode" id="aemeteringmode">
                                    {% else %}
                                    <select name="aemeteringmode" id="aemeteringmode" disabled>
                                    {% endif %}
                                        {% if cc.aeMeteringMode == 0 %}
                                        <option value="0" selected>Center Weighted</option>
                                        {% else %}
                                        <option value="0">Center Weighted</option>
                                        {% endif %}
                                        {% if cc.aeMeteringMode == 1 %}
                                        <option value="1" selected>Spot</option>
                                        {% else %}
                                        <option value="1">Spot</option>
                                        {% endif %}
                                        {% if cc.aeMeteringMode == 2 %}
                                        <option value="2" selected>Matrix</option>
                                        {% else %}
                                        <option value="2">Matrix</option>
                                        {% endif %}
                                        {% if cc.aeMeteringMode == 3 %}
                                        <option value="3" selected>Custom</option>
                                        {% else %}
                                        <option value="3">Custom</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_aeExposureMode == True %}
                                    <input type="checkbox" id="include_aeexposuremode" name="include_aeexposuremode"
                                        onclick="includeCtrl('include_aeexposuremode', 'aeexposuremode')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_aeexposuremode" name="include_aeexposuremode"
                                        onclick="includeCtrl('include_aeexposuremode', 'aeexposuremode')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Sets the constraint mode of the algorithm for 
                                        automatic gain control (AGC) and automatic exposure control (AEC).
                                    </span>
                                    <label for="aeexposuremode">AEC/AGC Exposure Mode:</label>
                                </td>
                                <td>
                                    {% if cc.include_aeExposureMode == True %}
                                    <select name="aeexposuremode" id="aeexposuremode">
                                    {% else %}
                                    <select name="aeexposuremode" id="aeexposuremode" disabled>
                                    {% endif %}
                                        {% if cc.aeExposureMode == 0 %}
                                        <option value="0" selected>Normal</option>
                                        {% else %}
                                        <option value="0">Normal</option>
                                        {% endif %}
                                        {% if cc.aeExposureMode == 1 %}
                                        <option value="1" selected>Short</option>
                                        {% else %}
                                        <option value="1">Short</option>
                                        {% endif %}
                                        {% if cc.aeExposureMode == 2 %}
                                        <option value="2" selected>Long</option>
                                        {% else %}
                                        <option value="2">Long</option>
                                        {% endif %}
                                        {% if cc.aeExposureMode == 3 %}
                                        <option value="3" selected>Custom</option>
                                        {% else %}
                                        <option value="3">Custom</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_aeConstraintMode == True %}
                                    <input type="checkbox" id="include_aeconstraintmode" name="include_aeconstraintmode"
                                        onclick="includeCtrl('include_aeconstraintmode', 'aeconstraintmode')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_aeconstraintmode" name="include_aeconstraintmode"
                                        onclick="includeCtrl('include_aeconstraintmode', 'aeconstraintmode')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Sets the constraint mode of the algorithm for 
                                        automatic gain control (AGC) and automatic exposure control (AEC).
                                    </span>
                                    <label for="aeconstraintmode">AEC/AGC Constraint Mode:</label>
                                </td>
                                <td>
                                    {% if cc.include_aeConstraintMode == True %}
                                    <select name="aeconstraintmode" id="aeconstraintmode">
                                    {% else %}
                                    <select name="aeconstraintmode" id="aeconstraintmode" disabled>
                                    {% endif %}
                                        {% if cc.aeConstraintMode == 0 %}
                                        <option value="0" selected>Normal</option>
                                        {% else %}
                                        <option value="0">Normal</option>
                                        {% endif %}
                                        {% if cc.aeConstraintMode == 1 %}
                                        <option value="1" selected>Highlight</option>
                                        {% else %}
                                        <option value="1">Highlight</option>
                                        {% endif %}
                                        {% if cc.aeConstraintMode == 2 %}
                                        <option value="2" selected>Shadows</option>
                                        {% else %}
                                        <option value="2">Shadows</option>
                                        {% endif %}
                                        {% if cc.aeConstraintMode == 3 %}
                                        <option value="3" selected>Custom</option>
                                        {% else %}
                                        <option value="3">Custom</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                            {% if cp.hasFlicker == True %}
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_aeFlickerMode == True %}
                                    <input type="checkbox" id="include_aeflickermode" name="include_aeflickermode"
                                        onclick="includeCtrl('include_aeflickermode', 'aeflickermode')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_aeflickermode" name="include_aeflickermode"
                                        onclick="includeCtrl('include_aeflickermode', 'aeflickermode')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Sets the flicker avoidance mode of the algorithm for
                                        automatic gain control (AGC) and automatic exposure control (AEC).
                                    </span>
                                    <label for="aeflickermode">AEC/AGC Flicker Mode:</label>
                                </td>
                                <td>
                                    {% if cc.include_aeFlickerMode == True %}
                                    <select name="aeflickermode" id="aeflickermode">
                                    {% else %}
                                    <select name="aeflickermode" id="aeflickermode" disabled>
                                    {% endif %}
                                        {% if cc.aeFlickerMode == 0 %}
                                        <option value="0" selected>Off</option>
                                        {% else %}
                                        <option value="0">Off</option>
                                        {% endif %}
                                        {% if cc.aeFlickerMode == 1 %}
                                        <option value="1" selected>Manual</option>
                                        {% else %}
                                        <option value="1">Manual</option>
                                        {% endif %}
                                        {% if cc.aeFlickerMode == 2 %}
                                        <option value="2" selected>Auto</option>
                                        {% else %}
                                        <option value="2">Auto</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_aeFlickerPeriod == True %}
                                    <input type="checkbox" id="include_aeflickerperiod" name="include_aeflickerperiod"
                                        onclick="includeCtrl('include_aeflickerperiod', 'aeflickerperiod')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_aeflickerperiod" name="include_aeflickerperiod"
                                        onclick="includeCtrl('include_aeflickerperiod', 'aeflickerperiod')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Sets the lighting flicker period in microseconds.<br>
                                        For example, for 50Hz mains lighting the flicker occurs at 100Hz, 
                                        so the period would be 10000 microseconds
                                    </span>
                                    <label for="aeflickerperiod">AEC/AGC Flicker Period:</label>
                                </td>
                                <td>
                                    {% if cc.include_aeFlickerPeriod == True %}
                                    <input type="number" id="aeflickerperiod" name="aeflickerperiod" min="0" value="{{ cc.aeFlickerPeriod }}">
                                    {% else %}
                                    <input type="number" id="aeflickerperiod" name="aeflickerperiod" min="0" value="{{ cc.aeFlickerPeriod }}" disabled>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                        </table>
                        <p style="margin-bottom: 0"></p>
                        <input class="w3-button w3-black" type="submit" value="Submit">
                    </form>
                </div>
            </div>
            {% if sc.lastLiveTab == "exposure" %}
            <div id="exposure" class="w3-container controlgroup">
            {% else %}
            <div id="exposure" class="w3-container controlgroup" style="display:none">
            {% endif %}
                <!-- Control settings for manual exposure control -->
                <h4>Exposure</h4>
                <div>
                    <form method="post" action="{{ url_for('home.exposure_control') }}">
                        <table class="w3-table-all">
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_exposureTime == True %}
                                    <input type="checkbox" id="include_exposuretime" name="include_exposuretime"
                                        onclick="includeCtrl('include_exposuretime', 'exposuretimesec')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_exposuretime" name="include_exposuretime"
                                        onclick="includeCtrl('include_exposuretime', 'exposuretimesec')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Exposure time (shutter speed) in sec. <br>A value of 0 will activate AE.
                                    </span>
                                    <label for="exposuretimesec">Exposure Time in sec:</label>
                                </td>
                                <td colspan="2">
                                    {% if cc.include_exposureTime == True %}
                                    <input type="number" id="exposuretimesec" name="exposuretimesec" min="0.0" max="999" step="0.000001" 
                                        value="{{ cc.exposureTimeSec }}">
                                    {% else %}
                                    <input type="number" id="exposuretimesec" name="exposuretimesec" min="0.0" max="999" step="0.000001" 
                                        value="{{ cc.exposureTimeSec }}" disabled>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_exposureValue == True %}
                                    <input type="checkbox" id="include_exposurevalue" name="include_exposurevalue"
                                        onclick="includeCtrl('include_exposurevalue', 'exposurevalue')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_exposurevalue" name="include_exposurevalue"
                                        onclick="includeCtrl('include_exposurevalue', 'exposurevalue')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Exposure compensation value in "stops", 
                                        which adjusts the target of the AEC/AGC algorithm.
                                        Positive values increase the target brightness,
                                        and negative values decrease it.<br>
                                        Zero represents the base or "normal" exposure level.
                                    </span>
                                    <label for="exposurevalue">Exposure Value:</label>
                                </td>
                                <td colspan="2">
                                    {% if cc.include_exposureValue == True %}
                                    <input type="number" id="exposurevalue" name="exposurevalue" min="-8.0" max="8.0" step="0.1" 
                                        value="{{ cc.exposureValue }}">
                                    {% else %}
                                    <input type="number" id="exposurevalue" name="exposurevalue" min="-8.0" max="8.0" step="0.1" 
                                        value="{{ cc.exposureValue }}" disabled>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_analogueGain == True %}
                                    <input type="checkbox" id="include_analoguegain" name="include_analoguegain"
                                        onclick="includeCtrl('include_analoguegain', 'analoguegain')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_analoguegain" name="include_analoguegain"
                                        onclick="includeCtrl('include_analoguegain', 'analoguegain')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Analogue gain applied by the sensor
                                    </span>
                                    <label for="analoguegain">Analogue Gain:</label>
                                </td>
                                <td colspan="2">
                                    {% if cc.include_analogueGain == True %}
                                    <input type="number" id="analoguegain" name="analoguegain" min="1.0" max="99.0" step="0.1" 
                                        value="{{ cc.analogueGain }}">
                                    {% else %}
                                    <input type="number" id="analoguegain" name="analoguegain" min="1.0" max="99.0" step="0.1" 
                                        value="{{ cc.analogueGain }}" disabled>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_colourGains == True %}
                                    <input type="checkbox" id="include_colourgains" name="include_colourgains"
                                        onclick="includeCtrl('include_colourgains', 'colourgainred', 'colourgainblue')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_colourgains" name="include_colourgains"
                                        onclick="includeCtrl('include_colourgains', 'colourgainred', 'colourgainblue')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Colour gain for red (left) and blue (right). The gain applied to red / blue pixels 
                                        by the Automatic White Balance algorithm (AWB)
                                    </span>
                                    <label for="colourgains">Colour Gain:</label>
                                </td>
                                <td>
                                    {% if cc.include_colourGains == True %}
                                    <input type="number" id="colourgainred" name="colourgainred" min="0.0" max="32.0" step="0.1" 
                                        value="{{ cc.colourGainRed }}">
                                    {% else %}
                                    <input type="number" id="colourgainred" name="colourgainred" min="0.0" max="32.0" step="0.1" 
                                        value="{{ cc.colourGainRed }}" disabled>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if cc.include_colourGains == True %}
                                    <input type="number" id="colourgainblue" name="colourgainblue" min="0.0" max="32.0" step="0.1" 
                                        value="{{ cc.colourGainBlue }}">
                                    {% else %}
                                    <input type="number" id="colourgainblue" name="colourgainblue" min="0.0" max="32.0" step="0.1" 
                                        value="{{ cc.colourGainBlue }}" disabled>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_frameDurationLimits == True %}
                                    <input type="checkbox" id="include_framedurationlimits" name="include_framedurationlimits"
                                        onclick="includeCtrl('include_framedurationlimits', 'framedurationlimitmax', 'framedurationlimitmin')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_framedurationlimits" name="include_framedurationlimits"
                                        onclick="includeCtrl('include_framedurationlimits', 'framedurationlimitmax', 'framedurationlimitmin')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        The maximum time (left) and minimum time (right) that the
                                        sensor can take to deliver a frame, measured
                                        in microseconds. So the reciprocal of these
                                        values (first divided by 1000000) will give the
                                        minimum / maximum framerates that the sensor can deliver.<br>
                                        A value of 0 reverts to using the camera default.
                                    </span>
                                    <label for="framedurationlimits">Frame Duration Lim Max/Min (s):</label>
                                </td>
                                <td>
                                    {% if cc.include_frameDurationLimits == True %}
                                    <input type="number" id="framedurationlimitmax" name="framedurationlimitmax" min="0" max="1000000" step="1" 
                                        value="{{ cc.frameDurationLimitMax }}">
                                    {% else %}
                                    <input type="number" id="framedurationlimitmax" name="framedurationlimitmax" min="0" max="1000000" step="1" 
                                        value="{{ cc.frameDurationLimitMax }}" disabled>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if cc.include_frameDurationLimits == True %}
                                    <input type="number" id="framedurationlimitmin" name="framedurationlimitmin" min="0" max="1000000" step="1" 
                                        value="{{ cc.frameDurationLimitMin }}">
                                    {% else %}
                                    <input type="number" id="framedurationlimitmin" name="framedurationlimitmin" min="0" max="1000000" step="1" 
                                        value="{{ cc.frameDurationLimitMin }}" disabled>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if cp.hasHdr == True %}
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_hdrMode == True %}
                                    <input type="checkbox" id="include_hdrmode" name="include_hdrmode"
                                        onclick="includeCtrl('include_hdrmode', 'hdrmode')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_hdrmode" name="include_hdrmode"
                                        onclick="includeCtrl('include_hdrmode', 'hdrmode')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Whether to run the camera in an HDR mode
                                        (distinct from the in-camera HDR supported by
                                        the Camera Module 3). Most of these HDR
                                        features work only on Pi 5 or later devices.
                                    </span>
                                    <label for="hdrmode">HDR Mode:</label>
                                </td>
                                <td colspan="2">
                                    {% if cc.include_hdrMode == True %}
                                    <select name="hdrmode" id="hdrmode">
                                    {% else %}
                                    <select name="hdrmode" id="hdrmode" disabled>
                                    {% endif %}
                                        {% if cc.hdrMode == 0 %}
                                        <option value="0" selected>Off</option>
                                        {% else %}
                                        <option value="0">Off</option>
                                        {% endif %}
                                        {% if cc.hdrMode == 1 %}
                                        <option value="1" selected>MultiExposureUnmerged</option>
                                        {% else %}
                                        <option value="1">MultiExposureUnmerged</option>
                                        {% endif %}
                                        {% if cc.hdrMode == 2 %}
                                        <option value="2" selected>MultiExposure</option>
                                        {% else %}
                                        <option value="2">MultiExposure</option>
                                        {% endif %}
                                        {% if cc.hdrMode == 3 %}
                                        <option value="3" selected>SingleExposure</option>
                                        {% else %}
                                        <option value="3">SingleExposure</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                            {% endif %}
                        </table>
                        <p style="margin-bottom: 0"></p>
                        <input class="w3-button w3-black" type="submit" value="Submit">
                    </form>
                </div>
            </div>
            {% if sc.lastLiveTab == "image" %}
            <div id="image" class="w3-container controlgroup">
            {% else %}
            <div id="image" class="w3-container controlgroup" style="display:none">
            {% endif %}
                <!-- Control settings for other image parameters -->
                <h4>Image</h4>
                <div>
                    <form method="post" action="{{ url_for('home.image_control') }}">
                        <table class="w3-table-all">
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_awbEnable == True %}
                                    <input type="checkbox" id="include_awbenable" name="include_awbenable"
                                        onclick="includeCtrl('include_awbenable', 'awbenable')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_awbenable" name="include_awbenable"
                                        onclick="includeCtrl('include_awbenable', 'awbenable')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Turn the auto white balance (AWB) algorithm
                                        on or off. When it is off, there will be no
                                        automatic updates to the colour gains.
                                    </span>
                                    <label for="awbenable">AWB enabled:</label>
                                </td>
                                <td>
                                    {% if cc.awbEnable == True %}
                                    {% if cc.include_awbEnable == True %}
                                    <input type="checkbox" id="awbenable" name="awbenable" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="awbenable" name="awbenable" value="1" checked disabled>
                                    {% endif %}
                                    {% else %}
                                    {% if cc.include_awbEnable == True%}
                                    <input type="checkbox" id="awbenable" name="awbenable" value="0">
                                    {% else %}
                                    <input type="checkbox" id="awbenable" name="awbenable" value="0" disabled>
                                    {% endif %}
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_awbMode == True %}
                                    <input type="checkbox" id="include_awbmode" name="include_awbmode"
                                        onclick="includeCtrl('include_awbmode', 'awbmode')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_awbmode" name="include_awbmode"
                                        onclick="includeCtrl('include_awbmode', 'awbmode')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Sets the mode of the Automatic White Balance algorithm.
                                    </span>
                                    <label for="awbmode">AWB Mode:</label>
                                </td>
                                <td>
                                    {% if cc.include_awbMode == True %}
                                    <select name="awbmode" id="awbmode">
                                        {% else %}
                                        <select name="awbmode" id="awbmode" disabled>
                                            {% endif %}
                                            {% if cc.awbMode == 0 %}
                                            <option value="0" selected>Auto</option>
                                            {% else %}
                                            <option value="0">Auto</option>
                                            {% endif %}
                                            {% if cc.awbMode == 2 %}
                                            <option value="2" selected>Tungsten</option>
                                            {% else %}
                                            <option value="2">Tungsten</option>
                                            {% endif %}
                                            {% if cc.awbMode == 3 %}
                                            <option value="3" selected>Fluorescent</option>
                                            {% else %}
                                            <option value="3">Fluorescent</option>
                                            {% endif %}
                                            {% if cc.awbMode == 4 %}
                                            <option value="4" selected>Indoor</option>
                                            {% else %}
                                            <option value="4">Indoor</option>
                                            {% endif %}
                                            {% if cc.awbMode == 5 %}
                                            <option value="5" selected>Daylight</option>
                                            {% else %}
                                            <option value="5">Daylight</option>
                                            {% endif %}
                                            {% if cc.awbMode == 6 %}
                                            <option value="6" selected>Cloudy</option>
                                            {% else %}
                                            <option value="6">Cloudy</option>
                                            {% endif %}
                                            {% if cc.awbMode == 7 %}
                                            <option value="7" selected>Custom</option>
                                            {% else %}
                                            <option value="7">Custom</option>
                                            {% endif %}
                                        </select>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_noiseReductionMode == True %}
                                    <input type="checkbox" id="include_noisereductionmode" name="include_noisereductionmode"
                                        onclick="includeCtrl('include_noisereductionmode', 'noisereductionmode')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_noisereductionmode" name="include_noisereductionmode"
                                        onclick="includeCtrl('include_noisereductionmode', 'noisereductionmode')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Selects a suitable noise reduction mode.
                                        Normally Picamera2s configuration will select
                                        an appropriate mode automatically, so it
                                        should not normally be necessary to change it.
                                        The HighQuality noise reduction mode can be
                                        expected to affect the maximum achievable
                                        framerate.
                                    </span>
                                    <label for="noisereductionmode">Noise Reduction Mode:</label>
                                </td>
                                <td>
                                    {% if cc.include_noiseReductionMode == True %}
                                    <select name="noisereductionmode" id="noisereductionmode">
                                        {% else %}
                                        <select name="noisereductionmode" id="noisereductionmode" disabled>
                                            {% endif %}
                                            {% if cc.noiseReductionMode == 0 %}
                                            <option value="0" selected>Off</option>
                                            {% else %}
                                            <option value="0">Off</option>
                                            {% endif %}
                                            {% if cc.noiseReductionMode == 1 %}
                                            <option value="1" selected>Fast</option>
                                            {% else %}
                                            <option value="1">Fast</option>
                                            {% endif %}
                                            {% if cc.noiseReductionMode == 2 %}
                                            <option value="2" selected>highQuality</option>
                                            {% else %}
                                            <option value="2">highQuality</option>
                                            {% endif %}
                                        </select>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_sharpness == True %}
                                    <input type="checkbox" id="include_sharpness" name="include_sharpness"
                                        onclick="includeCtrl('include_sharpness', 'sharpness')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_sharpness" name="include_sharpness"
                                        onclick="includeCtrl('include_sharpness', 'sharpness')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Sets the image sharpness, where zero implies
                                        no additional sharpening is performed, 1.0 is
                                        the default "normal" level of sharpening, and
                                        larger values apply proportionately stronger
                                        sharpening.
                                    </span>
                                    <label for="sharpness">Sharpness:</label>
                                </td>
                                <td>
                                    {% if cc.include_sharpness == True %}
                                    <input type="number" id="sharpness" name="sharpness" min="0.0" max="16.0" step="0.1"
                                        value="{{ cc.sharpness }}">
                                    {% else %}
                                    <input type="number" id="sharpness" name="sharpness" min="0.0" max="16.0" step="0.1"
                                        value="{{ cc.sharpness}}" disabled>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_contrast == True %}
                                    <input type="checkbox" id="include_contrast" name="include_contrast"
                                        onclick="includeCtrl('include_contrast', 'contrast')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_contrast" name="include_contrast"
                                        onclick="includeCtrl('include_contrast', 'contrast')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Sets the contrast of the image, where zero
                                        means "no contrast", 1.0 is the default "normal"
                                        contrast, and larger values increase the
                                        contrast proportionately.
                                    </span>
                                    <label for="contrast">Contrast:</label>
                                </td>
                                <td>
                                    {% if cc.include_contrast == True %}
                                    <input type="number" id="contrast" name="contrast" min="0.0" max="32.0" step="0.1" value="{{ cc.contrast }}">
                                    {% else %}
                                    <input type="number" id="contrast" name="contrast" min="0.0" max="32.0" step="0.1" value="{{ cc.contrast}}" disabled>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_saturation == True %}
                                    <input type="checkbox" id="include_saturation" name="include_saturation"
                                        onclick="includeCtrl('include_saturation', 'saturation')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_saturation" name="include_saturation"
                                        onclick="includeCtrl('include_saturation', 'saturation')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Amount of colour saturation, where zero
                                        produces greyscale images, 1.0 represents
                                        default "normal" saturation, and higher values
                                        produce more saturated colours.
                                    </span>
                                    <label for="saturation">Saturation:</label>
                                </td>
                                <td>
                                    {% if cc.include_saturation == True %}
                                    <input type="number" id="saturation" name="saturation" min="0.0" max="32.0" step="0.1" value="{{ cc.saturation }}">
                                    {% else %}
                                    <input type="number" id="saturation" name="saturation" min="0.0" max="32.0" step="0.1" value="{{ cc.saturation}}" disabled>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">
                                    {% if cc.include_brightness == True %}
                                    <input type="checkbox" id="include_brightness" name="include_brightness"
                                        onclick="includeCtrl('include_brightness', 'brightness')" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="include_brightness" name="include_brightness"
                                        onclick="includeCtrl('include_brightness', 'brightness')" value="0">
                                    {% endif %}
                                </td>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Adjusts the image brightness where -1.0 is
                                        very dark, 1.0 is very bright, and 0.0 is the
                                        default "normal" brightness.
                                    </span>
                                    <label for="brightness">Brightness:</label>
                                </td>
                                <td>
                                    {% if cc.include_brightness == True %}
                                    <input type="number" id="brightness" name="brightness" min="-1.0" max="1.0" step="0.1" value="{{ cc.brightness }}">
                                    {% else %}
                                    <input type="number" id="brightness" name="brightness" min="-1.0" max="1.0" step="0.1" value="{{ cc.brightness}}" disabled>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                        <p style="margin-bottom: 0; margin-top: 5px"></p>
                        <input class="w3-button w3-black" type="submit" value="Submit">
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="w3-row w3-border">
        <div class="w3-half">
            <!-- Lower left area -->
            <table class="w3-table-all">
                <tr>
                    <td style="width:44%">
                        <!-- Photo button -->
                        {% if sc.isVideoRecording %}
                        <form style="display:inline-block" method="post" action="{{ url_for('home.take_photo') }}">
                            <input class="w3-button w3-black w3-round-xxlarge" type="submit" value="Photo" disabled>
                        </form>
                        {% else %}
                        <form style="display:inline-block" method="post" action="{{ url_for('home.take_photo') }}">
                            <input class="w3-button w3-black w3-round-xxlarge" type="submit" value="Photo">
                        </form>
                        {% endif %}

                        <!-- raw button -->
                        {% if sc.isVideoRecording %}
                        <form style="display:inline-block" method="post" action="{{ url_for('home.take_raw_photo') }}">
                            <input class="w3-button w3-black w3-round-xxlarge" type="submit" value="Raw" disabled>
                        </form>
                        {% else %}
                        <form style="display:inline-block" method="post" action="{{ url_for('home.take_raw_photo') }}">
                            <input class="w3-button w3-black w3-round-xxlarge" type="submit" value="Raw">
                        </form>
                        {% endif %}
                        {% if sc.isVideoRecording == false %}
                        <form style="display:inline-block" method="post" action="{{ url_for('home.record_video') }}">
                            <input class="w3-button w3-black w3-round-xxlarge" type="submit" value="Video">
                        </form>
                        {% endif %}
                        {% if sc.isVideoRecording == true %}
                        <form style="display:inline-block" method="post" action="{{ url_for('home.stop_recording') }}">
                            <input class="w3-button w3-black w3-round-xxlarge" type="submit" value="Stop">
                        </form>
                        {% endif %}
                    </td>
                    <td style="width:14%">
                        <p style="margin-bottom: 0;">{{ sc.displayBufferIndex }}</p>
                    </td>
                    <td style="width:14%">
                    </td>
                    <td style="width:14%">
                        <!-- Show button: shows photo and meta -->
                        {% if sc.isDisplayHidden == true and sc.displayPhoto != None %}
                        <form method="post" action="{{ url_for('home.show_photo') }}">
                            <input class="w3-button w3-black" type="submit" value="Show">
                        </form>
                        {% endif %}
                        {% if sc.isDisplayHidden == false and sc.displayPhoto != None %}
                        <form method="post" action="{{ url_for('home.hide_photo') }}">
                            <input class="w3-button w3-black" type="submit" value="Hide">
                        </form>
                        {% endif %}
                    </td>
                    <td style="width:14%">
                        <!-- Clear button: clears Photo buffer -->
                        {% if sc.displayBufferCount > 0 or sc.displayPhoto != None %}
                        <form method="post" action="{{ url_for('home.clear_buffer') }}">
                            <input class="w3-button w3-black" type="submit" value="{{ sc.buttonClear }}">
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% if sc.isDisplayHidden == false and sc.displayPhoto != None %}
                <tr>
                    <td style="width:40%">
                        <!-- Photo filename -->
                        <p style="margin-bottom: 0">{{ sc.displayFile }}</p>
                    </td>
                    <td style="width:15%">
                        <!-- Button +: Add to buffer -->
                        {% if sc.isDisplayBufferIn() == false %}
                        <form method="post" action="{{ url_for('home.photoBuffer_add') }}">
                            <input class="w3-button w3-circle w3-black" type="submit" value="+">
                        </form>
                        {% else %}
                        <form method="post" action="{{ url_for('home.photoBuffer_add') }}">
                            <input class="w3-button w3-circle w3-black" type="submit" value="+" disabled>
                        </form>
                        {% endif %}
                    </td>
                    <td style="width:15%">
                        <!-- Button -: Remove from buffer -->
                        <form method="post" action="{{ url_for('home.photoBuffer_remove') }}">
                            <input class="w3-button w3-circle w3-black" type="submit" value="-">
                        </form>
                    </td>
                    <td style="width:15%">
                        <!-- Button <: Prev -->
                        {% if (sc.isDisplayBufferIn() == true and sc.isDisplayBufferFirst() == false) or sc.isDisplayBufferIn() == flase  %}
                        <form method="post" action="{{ url_for('home.photoBuffer_prev') }}">
                            <input class="w3-button w3-circle w3-black" type="submit" value="<">
                        </form>
                        {% else %}
                        <form method="post" action="{{ url_for('home.photoBuffer_prev') }}">
                            <input class="w3-button w3-circle w3-black" type="submit" value="<" disabled>
                        </form>
                        {% endif %}
                    </td>
                    <td style="width:15%">
                        <!-- Button >: Next -->
                        {% if (sc.isDisplayBufferIn() == true and sc.isDisplayBufferLast() == false) or sc.isDisplayBufferIn() == flase %}
                        <form method="post" action="{{ url_for('home.photoBuffer_next') }}">
                            <input class="w3-button w3-circle w3-black" type="submit" value=">">
                        </form>
                        {% else %}
                        <form method="post" action="{{ url_for('home.photoBuffer_next') }}">
                            <input class="w3-button w3-circle w3-black" type="submit" value=">" disabled>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <!-- The active Photo-->
                    <td colspan="5">
                        <img style="max-height: 600px;" src="{{ url_for('static', filename=sc.displayPhoto) }}" class="w3-image">
                    </td>
                </tr>
                {% endif %}
            </table>
        </div>
        <div class="w3-half">
            <!-- Lower right area: Metadata-->
            {% if sc.isDisplayHidden == false and sc.displayMeta != None %}
            <h4 style="min-height: 36px; padding-left: 17px">Metadata</h4>
            <table class="w3-table-all">
                <tr>
                    <th>Property</th>
                    <th>Value</th>
                </tr>
                {% for prop in sc.displayMeta %}
                {% if loop.index >= sc.displayMetaFirst and loop.index < sc.displayMetaLast %}
                <tr>
                    <td class="w3-tooltip">
                        {% if prop|string() == "SensorTimestamp" %}
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            The time this frame was produced by the
                            sensor, measured in nanoseconds since the
                            system booted. The time is sampled on the
                            camera start of frame interrupt, which occurs
                            as the first pixel of the new frame is written
                            out by the sensor. This control appears only in
                            captured image metadata and is read-only.
                        </span>
                        {% endif %}
                        {% if prop|string() == "ColourCorrectionMatrix" %}
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            The 33 matrix used within the image signal
                            processor (ISP) to convert the raw camera
                            colours to sRGB. This control appears only in
                            captured image metadata and is read-only.
                        </span>
                        {% endif %}
                        {% if prop|string() == "FocusFoM" %}
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Reports a Figure of Merit (FoM) to indicate how in-focus the frame is. A larger FocusFoM value indicates a more in-focus
                            frame. This singular value may be based on a combination of statistics gathered from multiple focus regions within an
                            image. The number of focus regions and method of combination is platform dependent. In this respect, it is not
                            necessarily aimed at providing a way to implement a focus algorithm by the application, rather an indication of how
                            in-focus a frame is.
                        </span>
                        {% endif %}
                        {% if prop|string() == "ColourTemperature" %}
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            An estimate of the colour temperature (in
                            Kelvin) of the current image. It is only available
                            in captured image metadata, and is read-only
                        </span>
                        {% endif %}
                        {% if prop|string() == "ColourGains" %}
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Pair of numbers where the first is the red gain
                            (the gain applied to red pixels by the AWB
                            algorithm) and the second is the blue gain.
                            Setting these numbers disables AWB.<br>
                            Range: [0.0,32.0]
                        </span>
                        {% endif %}
                        {% if prop|string() == "AeLocked" %}
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Report the lock status of a running AE algorithm.<br>
                            If the AE algorithm is locked the value shall be set to true, 
                            if it's converging it shall be set to false. 
                            If the AE algorithm is not running the control shall 
                            not be present in the metadata control list.
                        </span>
                        {% endif %}
                        {% if prop|string() == "Lux" %}
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            An estimate of the brightness (in lux) of the
                            scene. It is available only in captured image
                            metadata and is read-only.
                        </span>
                        {% endif %}
                        {% if prop|string() == "FrameDuration" %}
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            The amount of time (in microseconds) since
                            the previous camera frame. This value is only
                            available in captured image metadata and is
                            read-only. To change the cameras framerate,
                            the "FrameDurationLimits" control should be
                            used.
                        </span>
                        {% endif %}
                        {% if prop|string() == "SensorBlackLevels" %}
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            The black levels of the raw sensor image. This
                            control appears only in captured image
                            metadata and is read-only. One value is
                            reported for each of the four Bayer channels,
                            scaled up as if the full pixel range were 16 bits
                            (so 4096 represents a black level of 16 in 10-
                            bit raw data).
                        </span>
                        {% endif %}
                        {% if prop|string() == "DigitalGain" %}
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            The amount of digital gain applied to an
                            image. Digital gain is used automatically when
                            the sensors analogue gain control cannot go
                            high enough, and so this value is only reported
                            in captured image metadata. It cannot be set
                            directly - users should set the AnalogueGain
                            instead and digital gain will be used when
                            needed.
                        </span>
                        {% endif %}
                        {% if prop|string() == "AnalogueGain" %}
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Analogue gain applied by the sensor.
                        </span>
                        {% endif %}
                        {% if prop|string() == "ScalerCrop" %}
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            The scaler crop rectangle determines which
                            part of the image received from the sensor is
                            cropped and then scaled to produce an output
                            image of the correct size. It can be used to
                            implement digital pan and zoom. The
                            coordinates are always given from within the
                            full sensor resolution.
                        </span>
                        {% endif %}
                        {% if prop|string() == "ExposureTime" %}
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Exposure time used for the sensor, measured
                            in microseconds.<br>
                            In brackets for exposure times < 1s: rounded reciprocal value
                        </span>
                        {% endif %}
                        {% if prop|string() == "AfState" %}
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Reports the current state of the Autofocus (AF) algorithm in conjunction 
                            with the reported AfMode value and (in continuous AF mode) the AfPauseState value.<br> 
                            If the AfMode is set to AfModeManual, then the AfState will always report 
                            AfStateIdle (0) (even if the lens is subsequently moved). 
                            Changing to the AfModeManual state does not initiate any lens movement.<br>
                            If the AfMode is set to AfModeAuto then the AfState will report AfStateIdle (0). 
                            However, if AfModeAuto and AfTriggerStart are sent together 
                            then AfState will omit AfStateIdle (0) and move straight to AfStateScanning (1) (and start a scan).<br>
                            If the AfMode is set to AfModeContinuous then the AfState will initially report AfStateScanning (1).
                        </span>
                        {% endif %}
                        {% if prop|string() == "AfPauseState" %}
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Only applicable in continuous (AfModeContinuous) mode, 
                            this reports whether the algorithm is currently running (0), paused (2)
                            or pausing (1) (that is, will pause as soon as any in-progress scan completes).<br>
                            Any change to AfMode will cause AfPauseStateRunning (0) to be reported.
                        </span>
                        {% endif %}
                        {% if prop|string() == "SensorTemperature" %}
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Temperature measure from the camera sensor in Celsius. 
                            This is typically obtained by a thermal sensor present on-die or
                            in the camera module. The range of reported temperatures is device dependent.<br>
                            The SensorTemperature control will only be returned in metadata if a themal sensor is present.
                        </span>
                        {% endif %}
                        {% if prop|string() == "LensPosition" %}
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Position of the lens. The units are dioptres
                            (reciprocal of the distance in metres).<br>
                            In brackets: focal distance in m.
                        </span>
                        {% endif %}
                        {{ prop|string() }}
                    </td>
                    {% if prop|string() == "AfState" %}
                        {% if sc.displayMeta[prop]|string() == "0" %}
                            <td>{{ sc.displayMeta[prop]|string() }} (Idle)</td>
                        {% elif sc.displayMeta[prop]|string() == "1" %}
                            <td>{{ sc.displayMeta[prop]|string() }} (Scanning)</td>
                        {% elif sc.displayMeta[prop]|string() == "2" %}
                            <td>{{ sc.displayMeta[prop]|string() }} (Focused)</td>
                        {% elif sc.displayMeta[prop]|string() == "3" %}
                            <td>{{ sc.displayMeta[prop]|string() }} (Failed)</td>
                        {% else %}
                            <td>{{ sc.displayMeta[prop]|string() }}</td>
                        {% endif %}
                    {% elif prop|string() == "AfPauseState" %}
                        {% if sc.displayMeta[prop]|string() == "0" %}
                            <td>{{ sc.displayMeta[prop]|string() }} (Running)</td>
                        {% elif sc.displayMeta[prop]|string() == "1" %}
                            <td>{{ sc.displayMeta[prop]|string() }} (Pausing)</td>
                        {% elif sc.displayMeta[prop]|string() == "2" %}
                            <td>{{ sc.displayMeta[prop]|string() }} (Paused)</td>
                        {% else %}
                            <td>{{ sc.displayMeta[prop]|string() }}</td>
                        {% endif %}
                    {% elif prop|string() == "LensPosition" %}
                        {% set fdr = (1000.0/sc.displayMeta[prop])|int() %}
                        {% set fd = fdr/1000.0 %}
                        <td>{{ sc.displayMeta[prop]|string() }} ({{ fd|string() }} m)</td>
                    {% elif prop|string() == "ExposureTime" %}
                        {% if sc.displayMeta[prop] < 1000000 %}
                            {% set rt = (1000000/sc.displayMeta[prop])|int() %}
                            <td>{{ sc.displayMeta[prop]|string() }} (1/{{ rt|string() }} s)</td>
                        {% else %}
                            <td>{{ sc.displayMeta[prop]|string() }}</td>
                        {% endif %}
                    {% else %}
                    <td>{{ sc.displayMeta[prop]|string() }}</td>
                    {% endif %}
                </tr>
                {% endif%}
                {% endfor %}
            </table>
            <p> </p>
            <table class="w3-table">
                <tr>
                    <td style="width:25%">
                    </td>
                    <td style="width:25%">
                    </td>
                    <td style="width:25%">
                        {% if sc.displayMetaFirst == 0 %}
                        <form method="post" action="{{ url_for('home.meta_prev') }}">
                            <input class="w3-button w3-black" style="width:80%" type="submit" value="Previous" disabled>
                        </form>
                        {% else %}
                        <form method="post" action="{{ url_for('home.meta_prev') }}">
                            <input class="w3-button w3-black" style="width:80%" type="submit" value="Previous">
                        </form>
                        {% endif %}
                    </td>
                    <td style="width:25%">
                        {% if sc.displayMetaLast < 999 %}
                        <form method="post" action="{{ url_for('home.meta_next') }}">
                            <input class="w3-button w3-black" style="width:80%" type="submit" value="Next">
                        </form>
                        {% else %}
                        <form method="post" action="{{ url_for('home.meta_next') }}">
                            <input class="w3-button w3-black" style="width:80%" type="submit" value="Next" disabled>
                        </form>
                        {% endif %}
                    </td>
                </tr>
            </table>

            {% endif %}
        </div>
    </div>
    <script>
        function openCtrlTab(ctrlTabName, ctrlTabBtn) {
            /*  Opens the selected Tab for camera controls
                ctrlTabName:    Name of the tab to be opened
                ctrlTabBtn:     Button in the button-bar to be highlighted
            */
            var i;
            var x = document.getElementsByClassName("controlgroup");
            for (i = 0; i < x.length; i++) {
                x[i].style.display = "none";
            }
            document.getElementById(ctrlTabName).style.display = "block";

            var b = document.getElementsByClassName("ctrlmenu");
            for (i = 0; i < b.length; i++) {
                b[i].classList = "w3-bar-item w3-button ctrlmenu";
            }
            document.getElementById(ctrlTabBtn).classList = "w3-bar-item w3-button ctrlmenu w3-light-green";

            if (ctrlTabName == "focus") {
                drawAfWindow("include_afwindows", "afwindows", '{{ sc.scalerCropLiveView }}')
                drawAllAfWindows()
            } else {
                removeAfWindowCanvas()
            }
        }
    </script>
    <script>
        function includeCtrl(cbId, ctrlId, ctrlId2) {
            var cb = document.getElementById(cbId);
            if (cb.checked == true) {
                document.getElementById(ctrlId).disabled = false;
                if (ctrlId2 !== undefined) {
                    document.getElementById(ctrlId2).disabled = false;
                }
            } else {
                document.getElementById(ctrlId).disabled = true;
                if (ctrlId2 !== undefined) {
                    document.getElementById(ctrlId2).disabled = true;
                }
            }
        }
    </script>
    <script>
        function enableAfWindows() {
            /*  enable tha afwindows text field to allow Flask to request its content
            */
            document.getElementById("afwindows").disabled = false
        }
    </script>
    <script>
        function showAfWindows(tabSelected, trg, tgt, camRef) {
            /*  If camera has focus and if focus tab is selected,
                show th AF Windows
                This function is called after the page finished loading
                in order to assure initial visibility of AF windows
                tabSelected:    name of the initially selected tab
                trg:            Trigger (checkbox)
                                If checked, canvas and AF Windows are drawn
                                If unchecked, canvas is removed
                tgt:            Target element taking windows
                canRef:         Current scaler crop
            */
            if (tabSelected == "focus") {
                drawAfWindow(trg, tgt, camRef)
            }
        }

    </script>
    <script>
        var afWinTarget;
        var liveCanvas;
        var liveCanvasCtx;
        var liveCanvasOffsetX;
        var liveCanvasOffsetY;
        var mouseIsDown;
        var mouseStartX;
        var mouseStartY;
        var camXOffset;
        var camYOffset;
        var camWidth;
        var camHeight;
        var winXOffset;
        var winYOffset;
        var winWidth;
        var winHeight;

        function removeAfWindowCanvas(){
            /*  Removes the canvas for AF Windows
            */
            var cnvEl = document.getElementById("livecanvas");
            if (cnvEl) {
                // Unregister event listeners
                document.getElementById('livecanvas').removeEventListener('mousedown', function (e) {
                    handleMouseDown(e);
                });
                document.getElementById('livecanvas').removeEventListener('mousemove', function (e) {
                    handleMouseMove(e);
                });
                document.getElementById('livecanvas').removeEventListener('mouseup', function (e) {
                    handleMouseUp(e);
                });
                document.getElementById('livecanvas').removeEventListener('mouseout', function (e) {
                    handleMouseOut(e);
                });   
                // Remove canvas             
                document.body.removeChild(cnvEl);
                liveCanvas = null;
                liveCanvasCtx = null;
            }
        }

        function parseWindows(wins) {
            /*  Parses the tuple of one or multiple rectangles
                ((x,x,x,x),(x,x,x,x))
                and returns an array of rectangles as strings
            */
            var resa = [];
            var cnt = 0;
            if (wins[0] == "(") {
                var wns = wins.slice(1);
                if (wns[wns.length - 1] == ")") {
                    wns = wns.slice(0, wns.length - 1);
                    while (wns.length > 0) {
                        var i = wns.indexOf(")");
                        if ( i > 0) {
                            wn = wns.slice(0, i + 1);
                            resa[cnt] = wn;
                            cnt = cnt + 1;
                            if (i < wns.length) {
                                wns = wns.slice(i + 2);
                            } else {
                                wns = "";
                            }
                        } else {
                            wns = "";
                        }
                    }
                }
            }
            return resa;
        }

        function drawCnvWindow(win, index, winlist) {
            /*  Draw the given window on the canvas
            */
            //console.log("drawCnvWindow win:", win);

            // Parse the window spec for the AF Window
            var afWina = parseRectTuple(win);
            var afWinXOffset = afWina[0];
            var afWinYOffset = afWina[1];
            var afWinWidth = afWina[2];
            var afWinHeight = afWina[3];
            //console.log("cnv: ", liveCanvasOffsetX, liveCanvasOffsetY, liveCanvas.width, liveCanvas.height)
            //console.log("cam: ", camXOffset, camYOffset, camWidth, camHeight)
            //console.log("afw: ", afWinXOffset, afWinYOffset, afWinWidth, afWinHeight)

            // Scale to canvas
            var winWidth = Math.round(afWinWidth * liveCanvas.width / camWidth);
            var winHeight = Math.round(afWinHeight * liveCanvas.height / camHeight);
            var winXOffset = Math.round((afWinXOffset - camXOffset) * liveCanvas.width / camWidth);
            var winYOffset = Math.round((afWinYOffset - camYOffset) * liveCanvas.height / camHeight);
            //console.log("win: ", winXOffset, winYOffset, winWidth, winHeight)

            // Draw
            liveCanvasCtx.strokeRect(winXOffset, winYOffset, winWidth, winHeight);
        }

        function drawAllAfWindows() {
            /*  Parses the windows entry in the target element
                and draws all resulting windows
            */
            //console.log("drawAllAfWindows")
            var afWindows = afWinTarget.value;
            //console.log("afWindows:", afWindows)
            var winlist = parseWindows(afWindows)
            //console.log("winlist:", winlist)

            // Clear canvas
            liveCanvasCtx.clearRect(0, 0, liveCanvas.width, liveCanvas.height);

            // Draw all windows
            winlist.forEach(drawCnvWindow)
        }

        function addNewAfWindow() {
            /*  add a new AF Window to the tuple of windows available in the target element
            */
            // Scale
            //console.log('addNewAfWindow');
            //console.log("cnv: ", liveCanvasOffsetX, liveCanvasOffsetY, liveCanvas.width, liveCanvas.height)
            //console.log("cam: ", camXOffset, camYOffset, camWidth, camHeight)
            //console.log("win: ", winXOffset, winYOffset, winWidth, winHeight)
            var afWinWidth = Math.round(winWidth * camWidth / liveCanvas.width);
            var afWinHeight = Math.round(winHeight * camHeight / liveCanvas.height);
            var afWinXOffset = Math.round(camXOffset + winXOffset * camWidth / liveCanvas.width);
            var afWinYOffset = Math.round(camYOffset + winYOffset * camHeight / liveCanvas.height);
            var afWindows = afWinTarget.value;
            //console.log("afWindows old:", afWindows);

            // Convatenate to afWindows
            afWindows = afWindows.slice(0, afWindows.length - 1);
            if (afWindows.length > 1) {
                afWindows = afWindows + ","
            }
            afWindows = afWindows 
                + "(" 
                + afWinXOffset.toString() + "," 
                + afWinYOffset.toString() + ","
                + afWinWidth.toString() + ","
                + afWinHeight.toString()
                + ")";
            afWindows = afWindows + ")";
            //console.log("afWindows new:", afWindows);

            // Store in target
            afWinTarget.value = afWindows;
        }

        function handleMouseDown(e) {
            /*  In case of mouse down, memorize point as start of rectangle
            */
            //console.log('handleMouseDown')
            //console.log(e)
            e.preventDefault();
            e.stopPropagation();

            // save the starting x/y of the rectangle
            mouseStartX = parseInt(e.clientX - liveCanvasOffsetX);
            mouseStartY = parseInt(e.clientY - liveCanvasOffsetY);

            // set a flag indicating the drag has begun
            mouseIsDown = true;
        }

        function handleMouseUp(e) {
            /*  In case of mouse up, register end of drawing
            */
            //console.log('handleMouseUp');
            //console.log(e)
            e.preventDefault();
            e.stopPropagation();

            // the drag is over, clear the dragging flag
            mouseIsDown = false;

            // Add new window
            addNewAfWindow();
        }

        function handleMouseOut(e) {
            /*  In case of mouse leaving the canvas,
                Draw all windows
            */
            //console.log('handleMouseOut')
            //console.log(e)
            e.preventDefault();
            e.stopPropagation();

            // the drag is over, clear the dragging flag
            mouseIsDown = false;
            // Draw all windows
            drawAllAfWindows()
        }

        function handleMouseMove(e) {
            /*  While mouse is moving with mouse down,
                Clear canvas from previous rectangle
                and draw rectangle with new coordinates.
                Memorize rectangla parameters.
            */
            //console.log('handleMouseMove')
            //console.log(e)
            e.preventDefault();
            e.stopPropagation();

            // if we're not dragging, just return
            if (!mouseIsDown) {
                return;
            }

            // get the current mouse position
            mouseX = parseInt(e.clientX - liveCanvasOffsetX);
            mouseY = parseInt(e.clientY - liveCanvasOffsetY);

            // clear the canvas
            liveCanvasCtx.clearRect(0, 0, liveCanvas.width, liveCanvas.height);

            // calculate the rectangle width/height based
            // on starting vs current mouse position
            var width = mouseX - mouseStartX;
            var height = mouseY - mouseStartY;

            // draw a new rect from the start position 
            // to the current mouse position
            liveCanvasCtx.strokeRect(mouseStartX, mouseStartY, width, height);
            if (width >= 0) {
                winXOffset = mouseStartX;
                winWidth = width;
            } else {
                winXOffset = mouseX;
                winWidth = -1 * width;
            }
            if (height >= 0) {
                winYOffset = mouseStartY;
                winHeight = height;
            } else {
                winYOffset = mouseY;
                winHeight = -1 * height;
            }
        }

        function parseRectTuple(tuple) {
            /*  Parse a Python tuple for libcamera.Rectangle
                (xOffset, yOffset, width, height)
            */
            resn = [0, 0, 0, 0]
            if (tuple[0] == "(") {
                var tpl = tuple.slice(1)
                if (tpl[tpl.length - 1] == ")") {
                    tpl = tpl.slice(0, tpl.length - 1)
                    var res = tpl.split(",")
                    if (res.length == 4) {
                        resn = [parseInt(res[0]), parseInt(res[1]), parseInt(res[2]), parseInt(res[3])]
                    }
                }
            }
            return resn
        }

        function drawAfWindow(trg, tgt, camRef) {
            /*  Creates canvas over live view image and allows drawing of AF Windows
                trg: Trigger (checkbox)
                     If checked, canvas and AF Windows are drawn
                     If unchecked, canvas is removed
                tgt: Target element taking windows
            */
            //console.log("drawAfWindow trg:", trg, " tgt:", tgt, " camRef", camRef);
            var trgEl = document.getElementById(trg);
            afWinTarget = document.getElementById(tgt);
            // calculate camera crop window params
            var camCrop = parseRectTuple(camRef);
            camXOffset = camCrop[0];
            camYOffset = camCrop[1];
            camWidth = camCrop[2];
            camHeight = camCrop[3];
            //console.log(camXOffset, camYOffset, camWidth, camHeight);

            if (trgEl.checked == true) {
                // Trigger active -> prepare canvas
                var img = document.getElementById("liveviewimage");
                // Craete the canvas
                liveCanvas = document.createElement('canvas');
                liveCanvas.id = "livecanvas";
                document.body.appendChild(liveCanvas);
                // Position and size the canvas
                bRect = img.getBoundingClientRect();
                //console.log("img top:", bRect.top, " left:", bRect.left, " width:", bRect.width, " height:", bRect.height)
                liveCanvas.style.position = "absolute";
                liveCanvas.style.top = bRect.top + "px";
                liveCanvas.style.left = bRect.left + "px";
                liveCanvas.width = bRect.width;
                liveCanvas.height = bRect.height;
                // Set context
                liveCanvasCtx = liveCanvas.getContext("2d");
                liveCanvasCtx.strokeStyle = "red";
                liveCanvasCtx.lineWidth = 2;
                // Determine canvas position
                liveCanvasOffset = liveCanvas.getBoundingClientRect();
                liveCanvasOffsetX = liveCanvasOffset.left
                liveCanvasOffsetY = liveCanvasOffset.top
                // Initialize mouse down
                mouseIsDown = false;
                // Register event listeners
                document.getElementById('livecanvas').addEventListener('mousedown', function (e) {
                    handleMouseDown(e);
                });
                document.getElementById('livecanvas').addEventListener('mousemove', function (e) {
                    handleMouseMove(e);
                });
                document.getElementById('livecanvas').addEventListener('mouseup', function (e) {
                    handleMouseUp(e);
                });
                document.getElementById('livecanvas').addEventListener('mouseout', function (e) {
                    handleMouseOut(e);
                });                
            } else {
                // Trigger inactive -> destroy canvas and clear AFWindows
                var cnvEl = document.getElementById("livecanvas");
                if (cnvEl) {
                    // Unregister event listeners
                    document.getElementById('livecanvas').removeEventListener('mousedown', function (e) {
                        handleMouseDown(e);
                    });
                    document.getElementById('livecanvas').removeEventListener('mousemove', function (e) {
                        handleMouseMove(e);
                    });
                    document.getElementById('livecanvas').removeEventListener('mouseup', function (e) {
                        handleMouseUp(e);
                    });
                    document.getElementById('livecanvas').removeEventListener('mouseout', function (e) {
                        handleMouseOut(e);
                    });
                    // Remove canvas             
                    document.body.removeChild(cnvEl);
                    liveCanvas = null;
                    liveCanvasCtx = null;
                    // Clear afWindows field
                    afWinTarget.value = "()"
                }
            }
        }
    </script>
    <style>
        canvas {
            border: 1px solid red;
        }
    </style>

{% endblock %}