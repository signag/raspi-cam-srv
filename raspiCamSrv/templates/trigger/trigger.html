{% extends 'base.html' %}

{% block header %}
{% block title %}Trigger{% endblock %}
    <style>
        /* Custom styles for the photo viewer page */
        .video-wrapper {
        position: relative;
        width: 100%;
        }

        /* Native video */
        .video-wrapper video {
        width: 100%;
        display: block;
        }

        /* Overlay captures clicks on video surface only */
        .open-overlay {
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 20%; /* height of native controls */
        cursor: pointer;
        background: transparent;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="w3-bar w3-green">
        <!-- Trigger menu -->
        {% if sc.lastTriggerTab == "trgcontrol" %}
        <button class="w3-bar-item w3-button triggermenu w3-light-green" id="trgCtrlBtn"
            onclick="openTriggerTab('trgcontrol', 'trgCtrlBtn')">Control</button>
        {% else %}
        <button class="w3-bar-item w3-button triggermenu" id="trgCtrlBtn"
            onclick="openTriggerTab('trgcontrol', 'trgCtrlBtn')">Control</button>
        {% endif %}
        {% if sc.lastTriggerTab == "trgtriggers" %}
        <button class="w3-bar-item w3-button triggermenu w3-light-green" id="trgTriggersBtn"
            onclick="openTriggerTab('trgtriggers', 'trgTriggersBtn')">Triggers</button>
        {% else %}
        <button class="w3-bar-item w3-button triggermenu" id="trgTriggersBtn"
            onclick="openTriggerTab('trgtriggers', 'trgTriggersBtn')">Triggers</button>
        {% endif %}
        {% if sc.lastTriggerTab == "trgactions" %}
        <button class="w3-bar-item w3-button triggermenu w3-light-green" id="trgActionsBtn"
            onclick="openTriggerTab('trgactions', 'trgActionsBtn')">Actions</button>
        {% else %}
        <button class="w3-bar-item w3-button triggermenu" id="trgActionsBtn"
            onclick="openTriggerTab('trgactions', 'trgActionsBtn')">Actions</button>
        {% endif %}
        {% if sc.lastTriggerTab == "trgtriggeractions" %}
        <button class="w3-bar-item w3-button triggermenu w3-light-green" id="trgTriggerActionsBtn"
            onclick="openTriggerTab('trgtriggeractions', 'trgTriggerActionsBtn')">Trigger-Actions</button>
        {% else %}
        <button class="w3-bar-item w3-button triggermenu" id="trgTriggerActionsBtn"
            onclick="openTriggerTab('trgtriggeractions', 'trgTriggerActionsBtn')">Trigger-Actions</button>
        {% endif %}
        {% if sc.noCamera == False %}
        {% if sc.lastTriggerTab == "trgmotion" %}
        <button class="w3-bar-item w3-button triggermenu w3-light-green" id="trgmotionbtn"
            onclick="openTriggerTab('trgmotion', 'trgmotionbtn')">Motion</button>
        {% else %}
        <button class="w3-bar-item w3-button triggermenu" id="trgmotionbtn"
            onclick="openTriggerTab('trgmotion', 'trgmotionbtn')">Motion</button>
        {% endif %}
        {% if sc.lastTriggerTab == "trgaction" %}
        <button class="w3-bar-item w3-button triggermenu w3-light-green" id="trgactionbtn"
            onclick="openTriggerTab('trgaction', 'trgactionbtn')">Camera</button>
        {% else %}
        <button class="w3-bar-item w3-button triggermenu" id="trgactionbtn"
            onclick="openTriggerTab('trgaction', 'trgactionbtn')">Camera</button>
        {% endif %}
        {% endif %}
        {% if sc.lastTriggerTab == "trgnotify" %}
        <button class="w3-bar-item w3-button triggermenu w3-light-green" id="trgnotifybtn"
            onclick="openTriggerTab('trgnotify', 'trgnotifybtn')">Notification</button>
        {% else %}
        <button class="w3-bar-item w3-button triggermenu" id="trgnotifybtn"
            onclick="openTriggerTab('trgnotify', 'trgnotifybtn')">Notification</button>
        {% endif %}
        {% if sc.lastTriggerTab == "trgevents" %}
        <button class="w3-bar-item w3-button triggermenu w3-light-green" id="trgeventsbtn"
            onclick="openTriggerTab('trgevents', 'trgeventsbtn')">Events</button>
        {% else %}
        <button class="w3-bar-item w3-button triggermenu" id="trgeventsbtn"
            onclick="openTriggerTab('trgevents', 'trgeventsbtn')">Events</button>
        {% endif %}
        {% if sc.lastTriggerTab == "trgcalendar" %}
        <button class="w3-bar-item w3-button triggermenu w3-light-green" id="trgcalendarbtn"
            onclick="openTriggerTab('trgcalendar', 'trgcalendarbtn')">Calendar</button>
        {% else %}
        <button class="w3-bar-item w3-button triggermenu" id="trgcalendarbtn"
            onclick="openTriggerTab('trgcalendar', 'trgcalendarbtn')">Calendar</button>
        {% endif %}
        <div class="w3-bar-item w3-right" style="padding-top:2px; padding-bottom:0">
            <div class="w3-tooltip">
                <span style="position:absolute;right:45px;top:5px;width:200px" class="w3-text w3-tag">Online help from GitHub
                </span>
                <img src="{{ url_for('static', filename='onlineHelp.png') }}" class="w3-image" id="onlinehelp" alt="Online help"
                    style="height:34px; width:34px" onclick="onlineHelp()">
            </div>
        </div>
    </div>
    {% if sc.lastTriggerTab == "trgcontrol" %}
    <div id="trgcontrol" class="triggergroup">
    {% else %}
    <div id="trgcontrol" class="triggergroup" style="display:none">
    {% endif %}
        <form method="post" action="{{ url_for('trigger.trgcontrol') }}">
            <h4>Triggers and Actions</h4>
            <table class="w3-table-all">
                <tr>
                    <th colspan="2">
                        Triggers
                    </th>
                    {% if sc.noCamera == False %}
                    <th colspan="2">
                        Actions
                    </th>
                    {% else %}
                    <th>
                    </th>
                    {% endif %}
                    <th>
                    </th>
                </tr>
                {% if sc.noCamera == False %}
                <tr>
                    <td class="w3-tooltip" style="width:15%">
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Activate if you wish to trigger actions by motion detection.<br>
                            You need to specify details on the Motion tab
                        </span>
                        <label for="triggerbymotion">Motion Detection:</label>
                    </td>
                    <td style="width:10%">
                        {% if tc.triggeredByMotion == True %}
                        <input type="checkbox" id="triggerbymotion" name="triggerbymotion" value="1" checked>
                        {% else %}
                        <input type="checkbox" id="triggerbymotion" name="triggerbymotion" value="1">
                        {% endif %}
                    </td>
                    <td class="w3-tooltip" style="width:15%">
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Activate if you wish to capture video on a trigger event.<br>
                            You need to specify details on the Camera tab.
                        </span>
                        <label for="triggervideo">Record Video:</label>
                    </td>
                    <td style="width:10%">
                        {% if tc.actionVideo == True %}
                        <input type="checkbox" id="triggervideo" name="triggervideo" value="1" checked>
                        {% else %}
                        <input type="checkbox" id="triggervideo" name="triggervideo" value="1">
                        {% endif %}
                    </td>
                    <td style="width: 50%;">
                    </td>
                </tr>
                {% endif %}
                <tr>
                    <td class="w3-tooltip" style="width:15%">
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Activate if you wish to use general event handling.<br>
                            Details need to be configured on the Triggers, Actions and Trigger-Actions tabs.
                        </span>
                        <label for="triggerbyevents">Configured Triggers:</label>
                    </td>
                    <td style="width:10%">
                        {% if tc.triggeredByEvents == True %}
                        <input type="checkbox" id="triggerbyevents" name="triggerbyevents" value="1" checked>
                        {% else %}
                        <input type="checkbox" id="triggerbyevents" name="triggerbyevents" value="1">
                        {% endif %}
                    </td>
                    {% if sc.noCamera == False %}
                    <td class="w3-tooltip" style="width:15%">
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Activate if you wish to capture images on a trigger event.<br>
                            You need to specify details on the Camera tab
                        </span>
                        <label for="triggerphoto">Take Photo:</label>
                    </td>
                    <td style="width:10%;">
                        {% if tc.actionPhoto == True %}
                        <input type="checkbox" id="triggerphoto" name="triggerphoto" value="1" checked>
                        {% else %}
                        <input type="checkbox" id="triggerphoto" name="triggerphoto" value="1">
                        {% endif %}
                    </td>
                    {% else %}
                    <td>
                    </td>
                    {% endif %}
                    <td style="width:50%;">
                    </td>
                </tr>
                {% if sc.noCamera == False %}
                <tr>
                    <td style="width:15%">
                    </td>
                    <td style="width:10%">
                    </td>
                    <td class="w3-tooltip" style="width:15%">
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Activate if you wish to send a notification on a trigger event.<br>
                            You need to specify details on the Notification tab.
                        </span>
                        <label for="triggernotify">Notification:</label>
                    </td>
                    <td style="width:10%;">
                        {% if tc.actionNotify == True %}
                        <input type="checkbox" id="triggernotify" name="triggernotify" value="1" checked>
                        {% else %}
                        <input type="checkbox" id="triggernotify" name="triggernotify" value="1">
                        {% endif %}
                    </td>
                    <td style="width:50%;">
                    </td>
                </tr>
                {% endif %}
            </table>
            <p style="margin-bottom: 0"></p>
            <h4>Operation</h4>
            <table class="w3-table-all">
                <tr>
                    <td style="width:25%">
                    </td>
                    <td style="width: 5%;">Mon</td>
                    <td style="width: 5%;">Tue</td>
                    <td style="width: 5%;">Wed</td>
                    <td style="width: 5%;">Thu</td>
                    <td style="width: 5%;">Fri</td>
                    <td style="width: 5%;">Sat</td>
                    <td style="width: 5%;">Sun</td>
                    <td style="width: 40%;"></td>
                </tr>
                <tr>
                    <td class="w3-tooltip" style="width:25%">
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Select the weekdays when triggers shall be active
                        </span>
                        <label for="opweekday1">Operation Weekdays:</label>
                    </td>
                    {% for key, value in tc.operationWeekdays.items()  %}
                    <td style="width: 5%;">
                        {% if value == True %}
                        <input type="checkbox" id="opweekday{{key}}" name="opweekday{{key}}" value="1" checked>
                        {% else %}
                        <input type="checkbox" id="opweekday{{key}}" name="opweekday{{key}}" value="1">
                        {% endif %}
                    </td>
                    {% endfor %}
                    <td style="width: 40%;"></td>
                </tr>
                <tr>
                    <td class="w3-tooltip" style="width:25%">
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Time when triggering starts at every selected day
                        </span>
                        <label for="opstart">Operation Start:</label>
                    </td>
                    <td colspan="2" style="width: 10%;">
                        <input style="width:100%" type="time" id="opstart" name="opstart" value="{{ tc.operationStartStr }}">
                    </td>
                    <td colspan="6" style="width: 65%;"></td>
                </tr>
                <tr>
                    <td class="w3-tooltip" style="width:25%">
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Time when triggering ends at every selected day
                        </span>
                        <label for="opend">Operation End:</label>
                    </td>
                    <td colspan="2" style="width: 10%;">
                        <input style="width:100%" type="time" id="opend" name="opend" value="{{ tc.operationEndStr }}">
                    </td>
                    <td colspan="6" style="width: 65%;"></td>
                </tr>
                <tr>
                    <td class="w3-tooltip" style="width:25%">
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Automatically start with server start.<br>
                            Requires to store configuration and start server with stored configuration
                        </span>
                        <label for="opautostart">Automatic Start with Server:</label>
                    </td>
                    <td style="width:5%;">
                        {% if tc.operationAutoStart == True %}
                        <input type="checkbox" id="opautostart" name="opautostart" value="1" checked>
                        {% else %}
                        <input type="checkbox" id="opautostart" name="opautostart" value="0">
                        {% endif %}
                    </td>
                    <td colspan="6" style="width: 70%;"></td>
                </tr>
                <tr>
                    <td colspan="9" style="width: 100%;">&nbsp;</td>
                </tr>
                {% if sc.noCamera == False %}
                <tr>
                    <td class="w3-tooltip" style="width:25%">
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Delay in seconds for starting actions after trigger event
                        </span>
                        <label for="opdelay">Detection Delay (Sec):</label>
                    </td>
                    <td colspan="2" style="width: 10%;">
                        <input type="number" id="opdelay" name="opdelay" min="0" max="9999" step="1" value="{{ tc.detectionDelaySec }}">
                    </td>
                    <td colspan="6" style="width: 65%;"></td>
                </tr>
                <tr>
                    <td class="w3-tooltip" style="width:25%">
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Pause in seconds after a trigger event in which actions are not started
                        </span>
                        <label for="oppause">Detection Pause (Sec):</label>
                    </td>
                    <td colspan="2" style="width: 10%;">
                        <input type="number" id="oppause" name="oppause" min="0" max="9999" step="1" value="{{ tc.detectionPauseSec }}">
                    </td>
                    <td colspan="6" style="width: 65%;"></td>
                </tr>
                {% endif %}
                <tr>
                    <td class="w3-tooltip" style="width:25%">
                        <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                            Number of days for which data are kept on the server.<br>
                            Older data will be automatically deleted
                        </span>
                        <label for="retentionperiod">Retention Period (days):</label>
                    </td>
                    <td colspan="2" style="width: 10%;">
                        <input type="number" id="retentionperiod" name="retentionperiod" min="0" max="9999" step="1" value="{{ tc.retentionPeriod }}">
                    </td>
                    <td colspan="6" style="width: 65%;"></td>
                </tr>
            </table>
            <p style="margin-bottom: 0"></p>
            <input class="w3-button w3-black" type="submit" value="Submit">
        </form>
        <p style="margin-bottom: 0"></p>
        {% if sc.isTriggerRecording == False and sc.isEventhandling == False %}
        <form method="post" action="{{ url_for('trigger.start_triggered_capture') }}">
            <input class="w3-button w3-black w3-round-xxlarge" type="submit" value="Start">
        </form>
        {% else %}
        {% if sc.isTriggerTesting == False %}
        <form method="post" action="{{ url_for('trigger.stop_triggered_capture') }}">
            <input class="w3-button w3-black w3-round-xxlarge" type="submit" value="Stop">
        </form>
        {% else %}
        <form method="post" action="{{ url_for('trigger.stop_triggered_capture') }}">
            <input class="w3-button w3-black w3-round-xxlarge" type="submit" value="Stop" disabled>
        </form>
        {% endif %}
        {% endif %}
        {% if tc.error %}
        <p>&nbsp;</p>
        <hr>
        <div class="w3-panel w3-pale-red w3-border">
            <h3>Triggered capture stopped with error:</h3>
            <p>Error in {{ tc.errorSource }}: {{ tc.error }}</p>
            {% if tc.error2 != None %}
            <p>{{ tc.error2 }}</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% if sc.lastTriggerTab == "trgtriggers" %}
    <div id="trgtriggers" class="triggergroup">
    {% else %}
    <div id="trgtriggers" class="triggergroup" style="display:none">
    {% endif %}
        <div class="wr-row">
            <h3>Triggers</h3>
            <h4>New Trigger</h4>
            {% set triggerSource = "" %}
            {% set triggerDevice = "" %}
            {% set triggerEvent = "" %}
            {% set triggerEventSettings = "" %}
            {% set triggerId = "" %}
            {% if tmp|length() > 0 %}
            {% if "triggerSource" in tmp %}
            {% set triggerSource = tmp.triggerSource %}
            {% endif %}
            {% if "triggerDevice" in tmp %}
            {% set triggerDevice = tmp.triggerDevice %}
            {% endif %}
            {% if "triggerEvent" in tmp %}
            {% set triggerEvent = tmp.triggerEvent %}
            {% endif %}
            {% if "triggerEventSettings" in tmp %}
            {% set triggerEventSettings = tmp.triggerEventSettings %}
            {% endif %}
            {% if "triggerControl" in tmp %}
            {% set triggerControl = tmp.triggerControl %}
            {% endif %}
            {% if "triggerId" in tmp %}
            {% set triggerId = tmp.triggerId %}
            {% endif %}
            {% endif %}
            <form id="newtriggerform" method="post" action="{{ url_for('trigger.new_trigger') }}">
                <table>
                    <tr>
                        <td class="w3-tooltip" style="width:20%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Choose the source system for the trigger: Camera, GPIO or Motion Detector.
                            </span>
                            <label for="triggersource">Trigger Source:</label>
                        </td>
                        <td style="width:20%">
                            <select style="width:100%; height:28px" name="triggersource" id="triggersource"
                                onchange="dosubmitTriggerSource()">
                                {% if triggerSource == "" %}
                                <option value="" selected></option>
                                {% endif %}
                                {% for source in tc.triggerSources() %}
                                {% if source == triggerSource %}
                                <option value="{{ source }}" selected>{{ source }}</option>
                                {% else %}
                                <option value="{{ source }}">{{ source }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </td>
                        <td style="width:30%">
                        </td>
                        <td style="width:30%">
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:20%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Choose the device for which to register a trigger with.
                            </span>
                            <label for="triggerdevice">Trigger Device:</label>
                        </td>
                        <td style="width:20%">
                            {% if triggerSource == "" %}
                            <select style="width:100%; height:28px" name="triggerdevice" id="triggerdevice" disabled></select>
                            {% else %}
                            <select style="width:100%; height:28px" name="triggerdevice" id="triggerdevice"
                                onchange="dosubmitTriggerDevice()">
                                {% if triggerDevice == "" %}
                                <option value="" selected></option>
                                {% endif %}
                                {% for device in tc.triggerDevices(triggerSource) %}
                                {% if device == triggerDevice %}
                                <option value="{{ device }}" selected>{{ device }}</option>
                                {% else %}
                                <option value="{{ device }}">{{ device }}</option>
                                {% endif %}
                                {% endfor %}
                            {% endif %}
                            </select>
                        </td>
                        {% if triggerSource == "GPIO" and triggerDevice != "" %}
                        {% set device = sc.getDevice(triggerDevice) %}
                        <td style="width:30%">
                            <input style="width: 100%" type="text" id="triggerdevicetype" name="triggerdevicetype" value="{{ device.type }}" disabled>
                        </td>
                        <td style="width:30%">
                            {% set device = sc.getDeviceType(device.type) %}
                            <a id="triggerdevicedocurl" href="{{ device.docUrl }}" target="_blank">Link to gpiozero</a>
                        </td>
                        {% else %}
                        <td style="width:30%">
                        </td>
                        <td style="width:30%">
                        </td>
                        {% endif %}
                    </tr>
                    {% set events, eventSettings, control = tc.triggerEvents(triggerSource, triggerDevice) %}
                    <tr>
                        <td class="w3-tooltip" style="width:20%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Choose the triggering event for the selected device
                            </span>
                            <label for="triggerevent">Trigger Event:</label>
                        </td>
                        <td style="width:20%">
                            {% if triggerDevice == "" %}
                            <select style="width:100%; height:28px" name="triggerevent" id="triggerevent" disabled></select>
                            {% else %}
                            <select style="width:100%; height:28px" name="triggerevent" id="triggerevent"
                                onchange="dosubmitTriggerEvent()">
                                {% if triggerEvent == "" %}
                                <option value="" selected></option>
                                {% endif %}
                                {% for event in events %}
                                {% if event == triggerEvent %}
                                <option value="{{ event }}" selected>{{ event }}</option>
                                {% else %}
                                <option value="{{ event }}">{{ event }}</option>
                                {% endif %}
                                {% endfor %}
                            {% endif %}
                            </select>
                        </td>
                        <td style="width:30%">
                        </td>
                        <td style="width:30%">
                        </td>
                    </tr>
                    <div id="triggereventsettingsarea">
                    {% if triggerEvent != "" and triggerEventSettings|length() > 0 %}
                    {% for param, val in triggerEventSettings.items() %}
                    <tr>
                        <td class="w3-tooltip" style="width:20%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                The selected event requires specific parameters to be set.
                            </span>
                            <label for="trigger{{ param }}">Event Parameter:</label>
                        </td>
                        <td style="width:20%">
                            <input style="width: 100%" type="text" id="trigger_{{ param }}" name="trigger_{{ param }}" value="{{ param }}" disabled>
                        </td>
                        <td style="width:30%">
                            <input style="width: 100%" type="text" id="trigger_{{ param }}_value" name="trigger_{{ param }}_value"
                                value="{{ val }}">
                        </td>
                        <td style="width:30%">
                        </td>
                    </tr>
                    {% endfor %}
                    {% endif %}
                    </div>
                    <div id="triggercontrolarea">
                    {% if triggerEvent != "" and triggerControl|length() > 0 %}
                    {% for ctrlparam, ctrlval in triggerControl.items() %}
                    <tr>
                        <td class="w3-tooltip" style="width:20%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                The selected event requires specific control parameters to be set.
                            </span>
                            <label for="triggerctrl{{ ctrlparam }}">Control Parameter:</label>
                        </td>
                        <td style="width:20%">
                            <input style="width: 100%" type="text" id="triggerctrl{{ ctrlparam }}" name="triggerctrl{{ ctrlparam }}" value="{{ ctrlparam }}" disabled>
                        </td>
                        <td style="width:30%">
                            <input style="width: 100%" type="text" id="triggerctrl{{ ctrlparam }}_value" name="triggerctrl{{ ctrlparam }}_value"
                                value="{{ ctrlval }}">
                        </td>
                        <td style="width:30%">
                        </td>
                    </tr>
                    {% endfor %}
                    {% endif %}
                    </div>
                    <tr>
                        <td class="w3-tooltip" style="width:20%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Every trigger must be identified by a unique ID.
                            </span>
                            <label for="triggerid">Unique Trigger ID:</label>
                        </td>
                        <td style="width:20%">
                            {% if triggerEvent == "" %}
                            <input style="width: 100%" type="text" id="triggerid" name="triggerid" value="{{ triggerId }}" disabled>
                            {% else %}
                            <input style="width: 100%" type="text" id="triggerid" name="triggerid" value="{{ triggerId }}">
                            {% endif %}
                        </td>
                        <td style="width:30%">
                            {% if triggerEvent == "" %}
                            <input class="w3-button w3-black" type="submit" value="Submit" disabled>
                            {% else %}
                            <input class="w3-button w3-black" type="submit" value="Submit">
                            {% endif %}
                        </td>
                        <td style="width:30%">
                        </td>
                    </tr>
                </table>
            </form>
        </div>
        <div class="w3-row">
            <hr>
        </div>
        <div class="w3-row">
            <h4>Trigger Overview</h4>
            <form method="post" id="formtriggers" action="{{ url_for('trigger.trigger_activation') }}">
                <div style="max-height:58.5vh;overflow-y:auto">
                    <table class="w3-table-all">
                        <thead>
                            <tr>
                                <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                    ID
                                </th>
                                <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                    Active
                                </th>
                                <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                    Source
                                </th>
                                <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                    Device
                                </th>
                                <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                    Event
                                </th>
                                <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                    Parameters
                                </th>
                                <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                    Control
                                </th>
                                <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                    Delete
                                </th>
                            </tr>
                        </thead>
                        {% if tc.triggers|length() > 0 %}
                        <tbody>
                            {% for trigger in tc.triggers %}
                            <tr>
                                <td>
                                    {{ trigger.id }}
                                </td>
                                <td>
                                    {% if sc.isEventhandling %}
                                    {% if trigger.isActive == True %}
                                    <input type="checkbox" id="trigger{{ trigger.id }}_isactive" name="trigger{{ trigger.id }}_isactive" value="1" checked disabled>
                                    {% else %}
                                    <input type="checkbox" id="trigger{{ trigger.id }}_isactive" name="trigger{{ trigger.id }}_isactive" value="0" disabled>
                                    {% endif %}
                                    {% else %}
                                    {% if trigger.isActive == True %}
                                    <input type="checkbox" id="trigger{{ trigger.id }}_isactive" name="trigger{{ trigger.id }}_isactive" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="trigger{{ trigger.id }}_isactive" name="trigger{{ trigger.id }}_isactive" value="0">
                                    {% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    {{ trigger.source }}
                                </td>
                                <td>
                                    {{ trigger.device }}
                                </td>
                                <td>
                                    {{ trigger.event }}
                                </td>
                                <td>
                                    {{ trigger.params }}
                                </td>
                                <td>
                                    {{ trigger.control }}
                                </td>
                                <td>
                                    {% if sc.isEventhandling %}
                                    <input type="checkbox" id="trigger{{ trigger.id }}_delete" name="trigger{{ trigger.id }}_delete" value="0"
                                        onchange="countTriggerDelete('trigger{{ trigger.id }}_delete')" disabled>
                                    {% else %}
                                    <input type="checkbox" id="trigger{{ trigger.id }}_delete" name="trigger{{ trigger.id }}_delete" value="0"
                                        onchange="countTriggerDelete('trigger{{ trigger.id }}_delete')">
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        {% endif %}
                    </table>
                </div>
                <p style="margin-bottom: 0"></p>
                {% if tc.triggers|length() > 0 %}
                <input class="w3-button w3-black" type="submit" value="Submit" onclick="confirmDeleteTriggers('formtriggers')">
                {% else %}
                <input class="w3-button w3-black" type="submit" value="Submit" disabled>
                {% endif %}
            </form>
        </div>
    </div>
    {% if sc.lastTriggerTab == "trgactions" %}
    <div id="trgactions" class="triggergroup">
    {% else %}
    <div id="trgactions" class="triggergroup" style="display:none">
    {% endif %}
        <div class="wr-row">
            <h3>Actions</h3>
            <h4>New Action</h4>
            {% set actionSource = "" %}
            {% set actionDevice = "" %}
            {% set actionTarget = "" %}
            {% set actionId = "" %}
            {% if tmp|length() > 0 %}
            {% if "actionSource" in tmp %}
            {% set actionSource = tmp.actionSource %}
            {% endif %}
            {% if "actionDevice" in tmp %}
            {% set actionDevice = tmp.actionDevice %}
            {% endif %}
            {% if "actionTarget" in tmp %}
            {% set actionTarget = tmp.actionTarget %}
            {% endif %}
            {% if "actionId" in tmp %}
            {% set actionId = tmp.actionId %}
            {% endif %}
            {% endif %}
            <form id="newactionform" method="post" action="{{ url_for('trigger.new_action') }}">
                <table>
                    <tr>
                        <td class="w3-tooltip" style="width:20%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Choose the source system for the action: Camera, GPIO or SMTP
                            </span>
                            <label for="actionsource">Action Source:</label>
                        </td>
                        <td style="width:20%">
                            <select style="width:100%; height:28px" name="actionsource" id="actionsource"
                                onchange="dosubmitActionSource()">
                                {% if actionSource == "" %}
                                <option value="" selected></option>
                                {% endif %}
                                {% for source in tc.actionSources() %}
                                {% if source == actionSource %}
                                <option value="{{ source }}" selected>{{ source }}</option>
                                {% else %}
                                <option value="{{ source }}">{{ source }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </td>
                        <td style="width:30%">
                        </td>
                        <td style="width:30%">
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:20%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Choose the device for which to register an action with.
                            </span>
                            <label for="actiondevice">Action Device:</label>
                        </td>
                        <td style="width:20%">
                            {% if actionSource == "" %}
                            <select style="width:100%; height:28px" name="actiondevice" id="actiondevice" disabled></select>
                            {% else %}
                            <select style="width:100%; height:28px" name="actiondevice" id="actiondevice"
                                onchange="dosubmitActionDevice()">
                                {% if actionDevice == "" %}
                                <option value="" selected></option>
                                {% endif %}
                                {% for device in tc.actionDevices(actionSource) %}
                                {% if device == actionDevice %}
                                <option value="{{ device }}" selected>{{ device }}</option>
                                {% else %}
                                <option value="{{ device }}">{{ device }}</option>
                                {% endif %}
                                {% endfor %}
                            {% endif %}
                            </select>
                        </td>
                        {% if actionSource == "GPIO" and actionDevice != "" %}
                        {% set device = sc.getDevice(actionDevice) %}
                        <td style="width:30%">
                            <input style="width: 100%" type="text" id="actiondevicetype" name="actiondevicetype" value="{{ device.type }}" disabled>
                        </td>
                        <td style="width:30%">
                            {% set device = sc.getDeviceType(device.type) %}
                            <a id="devicedocurl" href="{{ device.docUrl }}" target="_blank">Link to gpiozero</a>
                        </td>
                        {% else %}
                        <td style="width:30%">
                        </td>
                        <td style="width:30%">
                        </td>
                        {% endif %}
                    </tr>
                    {% set actionTargets = tc.actionTargets(actionSource, actionDevice) %}
                    <tr>
                        <td class="w3-tooltip" style="width:20%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Choose the action method for the selected device
                            </span>
                            <label for="actionmethod">Action Method:</label>
                        </td>
                        <td style="width:20%">
                            {% if actionDevice == "" %}
                            <select style="width:100%; height:28px" name="actionmethod" id="actionmethod" disabled></select>
                            {% else %}
                            <select style="width:100%; height:28px" name="actionmethod" id="actionmethod"
                                onchange="dosubmitActionMethod()">
                                {% if actionTarget == "" %}
                                <option value="" selected></option>
                                {% else %}
                                {% if actionTarget.method == "" %}
                                <option value="" selected></option>
                                {% else %}
                                {% set method = actionTarget.method %}
                                {% endif %}
                                {% endif %}
                                {% for target in actionTargets %}
                                {% if target.method == method %}
                                <option value="{{ target.method }}" selected>{{ target.method }}</option>
                                {% else %}
                                <option value="{{ target.method }}">{{ target.method }}</option>
                                {% endif %}
                                {% endfor %}
                            {% endif %}
                            </select>
                        </td>
                        <td style="width:30%">
                        </td>
                        <td style="width:30%">
                        </td>
                    </tr>
                    <div id="actiontargetsettingsarea">
                    {% if actionTarget != "" %}
                    {% for target in actionTargets %}
                    {% if target.method == actionTarget.method %}
                    {% set method = actionTarget.method %}
                    {% if "params" in actionTarget %}
                    {% set params = actionTarget.params %}
                    {% else %}
                    {% set params = target.params %}
                    {% endif %}
                    {% if params|length() > 0 %}
                    {% for param, value in params.items() %}
                    <tr>
                        <td class="w3-tooltip" style="width:20%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                The selected action requires specific parameters to be set.
                            </span>
                            <label for="action_{{ method }}_param_{{ param }}_value">Action Parameter:</label>
                        </td>
                        <td style="width:20%">
                            <input style="width: 100%" type="text" id="action_{{ method }}_param_{{ param }}" name="action_{{ method }}_param_{{ param }}" value="{{ param }}" disabled>
                        </td>
                        <td style="width:30%">
                            <input style="width: 100%" type="text" id="action_{{ method }}_param_{{ param }}_value" name="action_{{ method }}_param_{{ param }}_value"
                                value="{{ value }}">
                        </td>
                        <td style="width:30%">
                        </td>
                    </tr>
                    {% endfor %}
                    {% endif %}
                    {% if "control" in actionTarget %}
                    {% set control = actionTarget.control %}
                    {% else %}
                    {% set control = target.control %}
                    {% endif %}
                    {% if control|length() > 0 %}
                    {% for ctrl, value in control.items() %}
                    <tr>
                        <td class="w3-tooltip" style="width:20%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                The selected action requires specific control parameters 
                                which may, for example specify the duration of the target device status
                                or the status shall be gradually reached.
                            </span>
                            <label for="action_{{ method }}_control_{{ ctrl }}_value">Control Parameter:</label>
                        </td>
                        <td style="width:20%">
                            <input style="width: 100%" type="text" id="action_{{ method }}_control_{{ ctrl }}"
                                name="action_{{ method }}_control_{{ ctrl }}" value="{{ ctrl }}" disabled>
                        </td>
                        <td style="width:30%">
                            <input style="width: 100%" type="text" id="action_{{ method }}_control_{{ ctrl }}_value"
                                name="action_{{ method }}_control_{{ ctrl }}_value" value="{{ value }}">
                        </td>
                        <td style="width:30%">
                        </td>
                    </tr>
                    {% endfor %}
                    {% endif %}
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                    </div>
                    <tr>
                        <td class="w3-tooltip" style="width:20%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Every action should and must be identified by a unique ID.
                            </span>
                            <label for="actionid">Unique Action ID:</label>
                        </td>
                        <td style="width:20%">
                            {% if actionTarget == "" %}
                            <input style="width: 100%" type="text" id="actionid" name="actionid" value="{{ actionId }}" disabled>
                            {% else %}
                            <input style="width: 100%" type="text" id="actionid" name="actionid" value="{{ actionId }}">
                            {% endif %}
                        </td>
                        <td style="width:30%">
                            {% if actionTarget == "" %}
                            <input class="w3-button w3-black" type="submit" value="Submit" disabled>
                            {% else %}
                            <input class="w3-button w3-black" type="submit" value="Submit">
                            {% endif %}
                        </td>
                        <td style="width:30%">
                        </td>
                    </tr>
                </table>
            </form>
        </div>
        <div class="w3-row">
            <hr>
        </div>
        <div class="w3-row">
            <h4>Action Overview</h4>
            <form id="formactions" method="post" action="{{ url_for('trigger.action_activation') }}">
                <div style="max-height:58.5vh;overflow-y:auto">
                    <table class="w3-table-all">
                        <thead>
                            <tr>
                                <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                    ID
                                </th>
                                <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                    Active
                                </th>
                                <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                    Source
                                </th>
                                <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                    Device
                                </th>
                                <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                    Action Method
                                </th>
                                <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                    Parameters
                                </th>
                                <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                    Control
                                </th>
                                <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                    Delete
                                </th>
                            </tr>
                        </thead>
                        {% if tc.actions|length() > 0 %}
                        <tbody>
                            {% for action in tc.actions %}
                            <tr>
                                <td>
                                    {{ action.id }}
                                </td>
                                <td>
                                    {% if sc.isEventhandling %}
                                    {% if action.isActive == True %}
                                    <input type="checkbox" id="action{{ action.id }}_isactive" name="action{{ action.id }}_isactive" value="1" checked disabled>
                                    {% else %}
                                    <input type="checkbox" id="action{{ action.id }}_isactive" name="action{{ action.id }}_isactive" value="0" disabled>
                                    {% endif %}
                                    {% else %}
                                    {% if action.isActive == True %}
                                    <input type="checkbox" id="action{{ action.id }}_isactive" name="action{{ action.id }}_isactive" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="action{{ action.id }}_isactive" name="action{{ action.id }}_isactive" value="0">
                                    {% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    {{ action.source }}
                                </td>
                                <td>
                                    {{ action.device }}
                                </td>
                                <td>
                                    {{ action.method }}
                                </td>
                                <td>
                                    {{ action.params }}
                                </td>
                                <td>
                                    {{ action.control }}
                                </td>
                                <td>
                                    {% if sc.isEventhandling %}
                                    <input type="checkbox" id="action{{ action.id }}_delete" name="action{{ action.id }}_delete" value="0"
                                        onchange="countActionDelete('action{{ action.id }}_delete')" disabled>
                                    {% else %}
                                    <input type="checkbox" id="action{{ action.id }}_delete" name="action{{ action.id }}_delete" value="0"
                                        onchange="countActionDelete('action{{ action.id }}_delete')">
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        {% endif %}
                    </table>
                </div>
                <p style="margin-bottom: 0"></p>
                {% if tc.actions|length() > 0 %}
                <input class="w3-button w3-black" type="submit" value="Submit" onclick="confirmDeleteActions('formactions')">
                {% else %}
                <input class="w3-button w3-black" type="submit" value="Submit" disabled>
                {% endif %}
            </form>
        </div>
    </div>
    {% if sc.lastTriggerTab == "trgtriggeractions" %}
    <div id="trgtriggeractions" class="triggergroup">
    {% else %}
    <div id="trgtriggeractions" class="triggergroup" style="display:none">
    {% endif %}
        <h3>Trigger Actions</h3>
        <div>
            <form method="post" action="{{ url_for('trigger.trigger_action') }}">
                <div style="max-height:78.5vh;max-width:95vw;overflow-x:auto;overflow-y:auto">
                    <table class="w3-table-all" style=" width: max-content;">
                        <thead>
                            <tr>
                                <th class="width:10%" style="background-color: #f1f1f1;position:sticky;top:0;left:0;z-index:12">
                                    Trigger
                                </th>
                                {% for action in tc.actions %}
                                <th class="width:5%; w3-center" style="background-color: #f1f1f1;position:sticky;top:0;z-index:10">
                                    {{ action.id }}
                                </th>
                                {% endfor %}
                                <th class="width:90%"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trigger in tc.triggers %}
                            {% set triggerId = trigger.id %}
                            {% set triggerActions = trigger.actions %}
                            <tr>
                                <th class="width:10%" style="position:sticky; left:0; background-color: #f1f1f1;z-index:11;">
                                    {{ trigger.id }}
                                </th>
                                {% for action in tc.actions %}
                                {% set actionId = action.id %}
                                <td class="width:5%; w3-center">
                                    {% if sc.isEventhandling %}
                                    {% if triggerActions[actionId] == True %}
                                    <input type="checkbox" id="triggeraction_{{ triggerId }}_{{ actionId }}" name="triggeraction_{{ triggerId }}_{{ actionId }}" value="1" checked disabled>
                                    {% else %}
                                    <input type="checkbox" id="triggeraction_{{ triggerId }}_{{ actionId }}" name="triggeraction_{{ triggerId }}_{{ actionId }}" value="0" disabled>
                                    {% endif %}
                                    {% else %}
                                    {% if triggerActions[actionId] == True %}
                                    <input type="checkbox" id="triggeraction_{{ triggerId }}_{{ actionId }}" name="triggeraction_{{ triggerId }}_{{ actionId }}" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="triggeraction_{{ triggerId }}_{{ actionId }}" name="triggeraction_{{ triggerId }}_{{ actionId }}" value="0">
                                    {% endif %}
                                    {% endif %}
                                </td>
                                {% endfor %}
                                <td class="width:90%"></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <p style="margin-bottom: 0"></p>
                <input class="w3-button w3-black" type="submit" value="Submit">
            </form>
        </div>
    </div>
    {% if sc.lastTriggerTab == "trgmotion" %}
    <div id="trgmotion" class="triggergroup">
    {% else %}
    <div id="trgmotion" class="triggergroup" style="display:none">
    {% endif %}
        <div class="w3-half">
            <h3>Motion Detection Configuration</h3>
            <form method="post" action="{{ url_for('trigger.motion') }}">
                <table class="w3-table-all">
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Choose the algorithm for motion detection
                            </span>
                            <label for="motiondetectionalgo">Motion Detection Algorithm:</label>
                        </td>
                        <td style="width:50%">
                            <select name="motiondetectionalgo" id="motiondetectionalgo" onchange="motionDetectionAlgoChanged()">
                                {% for algo in tc.motionDetectAlgos %}
                                {% if tc.motionDetectAlgo == loop.index %}
                                <option value="{{ loop.index }}" selected>{{ algo }}</option>
                                {% else %}
                                <option value="{{ loop.index }}">{{ algo }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Threshold for mean square deviation between successive frames
                                above which motion is detected.
                            </span>
                            <label for="msdthreshold">Mean Square Threshold:</label>
                        </td>
                        <td style="width:50%">
                            {% if tc.motionDetectAlgo == 1 %}
                            <input type="number" id="msdthreshold" name="msdthreshold" min="0" max="100" step="1" value="{{ tc.msdThreshold }}">
                            {% else %}
                            <input type="number" id="msdthreshold" name="msdthreshold" min="0" max="100" step="1" value="{{ tc.msdThreshold }}" disabled>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Minimum area for declaring a bounding box.
                            </span>
                            <label for="bboxthreshold">Bounding Box Threshold:</label>
                        </td>
                        <td style="width:50%">
                            {% if tc.motionDetectAlgo == 2 or tc.motionDetectAlgo == 3 or tc.motionDetectAlgo == 4 %}
                            <input type="number" id="bboxthreshold" name="bboxthreshold" min="0" max="10000" step="1" value="{{ tc.bboxThreshold }}">
                            {% else %}
                            <input type="number" id="bboxthreshold" name="bboxthreshold" min="0" max="10000" step="1" value="{{ tc.bboxThreshold }}" disabled>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                IOU (Intersection over Union) threshold for computing Non-Maximal Supression
                            </span>
                            <label for="nmsthreshold">IOU Threshold:</label>
                        </td>
                        <td style="width:50%">
                            {% if tc.motionDetectAlgo == 2 or tc.motionDetectAlgo == 3 or tc.motionDetectAlgo == 4 %}
                            <input type="number" id="nmsthreshold" name="nmsthreshold" min="0.000001" max="1" step="0.000001" value="{{ tc.nmsThreshold }}">
                            {% else %}
                            <input type="number" id="nmsthreshold" name="nmsthreshold" min="0.000001" max="1" step="0.000001" value="{{ tc.nmsThreshold }}" disabled>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Minimum threshold for Optical Flow algorithm.
                            </span>
                            <label for="motionthreshold">Motion Threshold:</label>
                        </td>
                        <td style="width:50%">
                            {% if tc.motionDetectAlgo == 3 %}
                            <input type="number" id="motionthreshold" name="motionthreshold" min="0" max="100" step="1" value="{{ tc.motionThreshold }}">
                            {% else %}
                            <input type="number" id="motionthreshold" name="motionthreshold" min="0" max="100" step="1" value="{{ tc.motionThreshold }}" disabled>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Background Subtraction Model:<br>
                                MOG2: Mixture of Gaussians 2<br>
                                KNN: K Nearest Neighbors
                            </span>
                            <label for="backsubmodel">Background Subtraction Model:</label>
                        </td>
                        <td style="width:50%">
                            {% if tc.motionDetectAlgo == 4 %}
                            <select name="backsubmodel" id="backsubmodel">
                            {% else %}
                            <select name="backsubmodel" id="backsubmodel" disabled>
                            {% endif %}
                                {% for bsm in tc.backgroundSubtractionModels %}
                                {% if tc.backSubModel == loop.index %}
                                <option value="{{ loop.index }}" selected>{{ bsm }}</option>
                                {% else %}
                                <option value="{{ loop.index }}">{{ bsm }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                {% if sc.cv2Available == True %}
                                Restrict motion detection to specific regions of interest.
                                {% else %}
                                OpenCV is not available. Regions of Interest cannot be used.
                                {% endif %}
                            </span>
                            <label for="useroi">Use Regions of Interest:</label>
                        </td>
                        <td style="width:50%">
                            {% if sc.cv2Available == True %}
                            {% if tc.useRoI == True %}
                            <input type="checkbox" id="useroi" name="useroi" 
                                onclick="drawRoiWindow('useroi', '{{ sc.scalerCropLiveView }}')"
                                value="1" checked>
                            {% else %}
                            <input type="checkbox" id="useroi" name="useroi" 
                                onclick="drawRoiWindow('useroi', '{{ sc.scalerCropLiveView }}')"
                                value="1">
                            {% endif %}
                            {% else %}
                            <input type="checkbox" id="useroi" name="useroi" 
                                onclick="drawRoiWindow('useroi', '{{ sc.scalerCropLiveView }}')"
                                value="0" disabled>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <label for="regionofinterest">Regions of Interest:</label>
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Regions of interest for motion detection<br>
                                A list of rectangles (tuples of 4 numbers
                                denoting x_offset, y_offset, width and
                                height). The rectangle units refer to the
                                maximum scaler crop window.
                            </span>
                        </td>
                        <td style="width:50%">
                            {% if tc.useRoI == True %}
                            <input type="text" id="regionofinterest" name="regionofinterest" value="{{ tc.regionOfInterestStr }}" disabled>
                            {% else %}
                            <input type="text" id="regionofinterest" name="regionofinterest" value="{{ tc.regionOfInterestStr }}" disabled>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <label for="regionofnointerest">Regions of No Interest:</label>
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Regions of no interest for motion detection<br>
                                Motion within these regions will not trigger an event.                         </span>
                        </td>
                        <td style="width:50%">
                            {% if tc.useRoI == True %}
                            <input type="text" id="regionofnointerest" name="regionofnointerest" value="{{ tc.regionOfNoInterestStr }}" disabled>
                            {% else %}
                            <input type="text" id="regionofnointerest" name="regionofnointerest" value="{{ tc.regionOfNoInterestStr }}" disabled>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Show bounding boxes of motion detection on recorded video.
                            </span>
                            <label for="videobboxes">Video with Bounding Boxes:</label>
                        </td>
                        <td style="width:50%">
                            {% if tc.videoBboxes == True %}
                            <input type="checkbox" id="videobboxes" name="videobboxes" value="1" checked>
                            {% else %}
                            <input type="checkbox" id="videobboxes" name="videobboxes" value="1">
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                {% if sc.cv2Available == True %}
                                Show Regions of Interest on recorded photos and videos.<br>
                                (For videos not available for Mean Square Difference algorithm)
                                {% else %}
                                Regions of Interest can not be shown on photos because OpenCV is not available.
                                {% endif %}
                            </span>
                            <label for="photorois">Photos/Videos with RoI/RoNI:</label>
                        </td>
                        <td style="width:50%">
                            {% if sc.cv2Available == True %}
                            {% if tc.photoRois == True %}
                            <input type="checkbox" id="photorois" name="photorois" value="1" checked>
                            {% else %}
                            <input type="checkbox" id="photorois" name="photorois" value="0">
                            {% endif %}
                            {% else %}
                            <input type="checkbox" id="photorois" name="photorois" value="0" disabled>
                            {% endif %}
                        </td>
                    </tr>
                </table>
                <p style="margin-bottom: 0"></p>
                <input class="w3-button w3-black" onclick="enableRegionOfInterest()" type="submit" value="Submit">
            </form>
            <hr>
            <!-- Live stream -->
            {% if tc.useRoI == True %}
            {% if sc.isLiveStream %}
            <div id="drawroictrl">
                <table>
                    <tr>
                        <td class="w3-tooltip" style="width:40%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Select to draw regions of interest for motion detection.
                            </span>
                            <label for="useroi">Draw Regions of Interest:</label>
                        </td>
                        <td style="width:10%">
                            <input type="checkbox" id="drawroi" name="drawroi" 
                                onclick="switchRoiType('drawroi', 'drawroni')"
                                value="1" checked>
                        </td>
                        <td class="w3-tooltip" style="width:40%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Select to draw regions of NO interest for motion detection.
                            </span>
                            <label for="useroi">Draw Regions of NO Interest:</label>
                        </td>
                        <td style="width:10%">
                            <input type="checkbox" id="drawroni" name="drawroni"
                                onclick="switchRoiType('drawroni', 'drawroi')"
                                value="0">
                        </td>
                    </tr>
                </table>
                <div id="roi-container" style="position: relative;">
                    <img src="{{ url_for('trigger.trg_live_view_feed') }}" class="w3-image" id="liveviewforroi" alt="Camera Live View">
                    <canvas id="canvasforroi"></canvas>
                </div>
            </div>
            {% endif %}
            {% endif %}
        </div>
        <div class="w3-half" style="height:88vh; overflow: auto">
            <div class="w3-center">
                <div class="w3-bar" style="margin-top:10px; margin-bottom:10px">
                    {% if tc.motionDetectAlgo > 1 %}
                    {% if sc.isTriggerTesting == False %}
                    {% if sc.isTriggerRecording == False %}
                    <form method="post" action="{{ url_for('trigger.test_motion_detection') }}">
                        <input class="w3-button w3-black w3-round-xxlarge" type="submit" value="Test Motion Detection">
                    </form>
                    {% else %}
                    <form method="post" action="{{ url_for('trigger.test_motion_detection') }}">
                        <input class="w3-button w3-black w3-round-xxlarge" type="submit" value="Test Motion Detection" disabled>
                    </form>
                    {% endif %}
                    {% else %}
                    <form method="post" action="{{ url_for('trigger.stop_test_motion_detection') }}">
                        <input class="w3-button w3-black w3-round-xxlarge" type="submit" value="Stop Test Motion Detection">
                    </form>
                    {% endif %}
                    {% else %}
                    <form method="post" action="{{ url_for('trigger.test_motion_detection') }}">
                        <input class="w3-button w3-black w3-round-xxlarge" type="submit" value="Test Motion Detection" disabled>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% if sc.isTriggerTesting == True %}
            <p style="margin-top:0px; margin-bottom:5px"> Reference: 
            <a href="{{ tc.motionRefURL }}" target="_blank">{{ tc.motionRefTit }}</a>
            </p>
            <table>
                <tr>
                    <td>
                        <img  style="width: 100%; height: 205px; object-fit: scale-down"
                            src="{{ url_for('trigger.test_frame1_feed') }}" 
                            alt="Test stream 1">
                    </td>
                </tr>
                <tr>
                    <td>
                        <p style="margin-top:0px; margin-bottom:5px; text-align:center">{{ tc.motionTestFrame1Title }}</p>
                    </td>
                </tr>
                <tr>
                    <td>
                        <img  style="width: 100%; height: 205px; object-fit: scale-down"
                            src="{{ url_for('trigger.test_frame2_feed') }}" 
                            alt="Test stream 2">
                    </td>
                </tr>
                <tr>
                    <td>
                        <p style="margin-top:0px; margin-bottom:5px; text-align:center">{{ tc.motionTestFrame2Title }}</p>
                    </td>
                </tr>
                <tr>
                    <td>
                        <img  style="width: 100%; height: 205px; object-fit: scale-down"
                            src="{{ url_for('trigger.test_frame3_feed') }}" 
                            alt="Test stream 3">
                    </td>
                </tr>
                <tr>
                    <td>
                        <p style="margin-top:0px; margin-bottom:5px; text-align:center">{{ tc.motionTestFrame3Title }}</p>
                    </td>
                </tr>
                <tr>
                    <td>
                        <img  style="width: 100%; height: 205px; object-fit: scale-down"
                            src="{{ url_for('trigger.test_frame4_feed') }}" 
                            alt="Test stream 4">
                    </td>
                </tr>
                <tr>
                    <td>
                        <p style="margin-top:0px; margin-bottom:5px; text-align:center">{{ tc.motionTestFrame4Title }}</p>
                    </td>
                </tr>
                <tr>
                    <td>
                        <p style="text-align:center; display:inline-block">Current Framerate: {{ tc.motionTestFramerate|round(1) }} fps</p>
                        <button class="w3-button w3-circle w3-green" 
                                style="display:inline-block" 
                                onclick="location.reload()">
                                <span style="font-family: 'Wingdings 3'">&#x0050;</span>
                        </button>
                    </td>
                </tr>
            </table>
            {% endif %}
        </div>
    </div>
    {% if sc.lastTriggerTab == "trgaction" %}
    <div id="trgaction" class="triggergroup">
    {% else %}
    <div id="trgaction" class="triggergroup" style="display:none">
    {% endif %}
        <h3>Camera Actions</h3>
        <div class="w3-half">
            <form method="post" action="{{ url_for('trigger.action') }}">
                <table class="w3-table-all">
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Normal recording starts when triggered.<br>
                                Circular recording continuously buffers in a circular buffer
                                and starts recording some seconds before being triggered.
                            </span>
                            <label for="actionvr">Video Recording Type:</label>
                        </td>
                        <td style="width:50%">
                            <select name="actionvr" id="actionvr">
                                {% for vr in tc.videoRecorders %}
                                {% if tc.actionVR == loop.index %}
                                <option value="{{ loop.index }}" selected>{{ vr }}</option>
                                {% else %}
                                <option value="{{ loop.index }}">{{ vr }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Size of circular buffer (pre-recording, buffered video to have before a event occurs) in seconds.<br>
                                The recorded video starts the given number of seconds before the event. Recommended max of 10 seconds (Longer = More used memory).
                            </span>
                            <label for="actioncircsize">Pre-Record Length (sec):</label>
                        </td>
                        <td style="width:50%">
                            <input type="number" id="actioncircsize" name="actioncircsize" min="0" max="10" step="1"
                                value="{{ tc.actionCircSize }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                The intended duration of videos recorded on an event.
                            </span>
                            <label for="actionvideoduration">Video Duration (sec):</label>
                        </td>
                        <td style="width:50%">
                            <input type="number" id="actionvideoduration" name="actionvideoduration" min="0" max="9999" step="1"
                                value="{{ tc.actionVideoDuration }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                The number of photos to be taken in sequence for each event.
                            </span>
                            <label for="actionphotoburst">Photo Burst - Number of Photos:</label>
                        </td>
                        <td style="width:50%">
                            <input type="number" id="actionphotoburst" name="actionphotoburst" min="1" max="10" step="1"
                                value="{{ tc.actionPhotoBurst }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                The time in seconds between successive photos of a photo burst.
                            </span>
                            <label for="actionphotoburstdelaysec">Photo Burst Interval (sec):</label>
                        </td>
                        <td style="width:50%">
                            <input type="number" id="actionphotoburstdelaysec" name="actionphotoburstdelaysec" min="0" max="10" step="1"
                                value="{{ tc.actionPhotoBurstDelaySec }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Folder for storage of event data, photos and videos.
                            </span>
                            <label for="actionpath">Action Data Path:</label>
                        </td>
                        <td style="width:50%">
                            <input style="width: 100%; text-align:right" type="text" id="actionpath" name="actionpath"
                                value="{{ tc.actionPath }}" disabled>
                        </td>
                    </tr>
                </table>
                <p style="margin-bottom: 0"></p>
                <input class="w3-button w3-black" type="submit" value="Submit">
            </form>
        </div>
    </div>
    {% if sc.lastTriggerTab == "trgnotify" %}
    <div id="trgnotify" class="triggergroup">
    {% else %}
    <div id="trgnotify" class="triggergroup" style="display:none">
    {% endif %}
        <h3>Notification Settings</h3>
        <div class="w3-half">
            {% if tc.notifyConOK == False %}
            <h3 class="w3-red">Please enter credentials to check notification recipient</h3>
            {% else %}
            <h3 class="w3-green">Mail account for notification is already verified</h3>
            {% endif %}
            <form method="post" action="{{ url_for('trigger.notify') }}">
                <table class="w3-table-all">
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                SMTP Server
                            </span>
                            <label for="notifyhost">SMTP Server:</label>
                        </td>
                        <td style="width:50%">
                            <input type="text" id="notifyhost" name="notifyhost" value="{{ tc.notifyHost }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Port
                            </span>
                            <label for="notifyport">Port:</label>
                        </td>
                        <td style="width:50%">
                            <input type="number" id="notifyport" name="notifyport" min="1" max="65535" step="1"
                                value="{{ tc.notifyPort }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Use SSL.
                            </span>
                            <label for="notifyusessl">Use SSL:</label>
                        </td>
                        <td style="width:50%">
                            {% if tc.notifyUseSSL == True %}
                            <input type="checkbox" id="notifyusessl" name="notifyusessl" value="1" checked>
                            {% else %}
                            <input type="checkbox" id="notifyusessl" name="notifyusessl" value="1">
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 50%;">&nbsp;</td>
                        <td style="width: 50%;">&nbsp;</td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Check if server requires authentication.
                            </span>
                            <label for="notifyauthenticate">Server requires Authentication:</label>
                        </td>
                        <td style="width:50%">
                            {% if tc.notifyAuthenticate == True %}
                            <input type="checkbox" id="notifyauthenticate" name="notifyauthenticate" 
                                onclick="mailServerAuthenicationChanged()" value="1" checked>
                            {% else %}
                            <input type="checkbox" id="notifyauthenticate" name="notifyauthenticate" 
                                onclick="mailServerAuthenicationChanged()" value="1">
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                User<br>
                                Leave this empty if a E-Mail account is already verified.
                            </span>
                            <label for="notifyuser">User:</label>
                        </td>
                        <td style="width:50%">
                            {% if tc.notifyAuthenticate == True %}
                            <input type="text" id="notifyuser" name="notifyuser" value="">
                            {% else %}
                            <input type="text" id="notifyuser" name="notifyuser" value="" disabled>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Password<br>
                                Leave this empty if a E-Mail account is already verified.
                            </span>
                            <label for="notifypassword">Password:</label>
                        </td>
                        <td style="width:50%">
                            {% if tc.notifyAuthenticate == True %}
                            <input type="password" id="notifypassword" name="notifypassword" value="">
                            {% else %}
                            <input type="password" id="notifypassword" name="notifypassword" value="" disabled>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Activate checkbox if you want the password to be stored in a file.
                            </span>
                            <label for="notifysavepwd">Store Credentials in File:</label>
                        </td>
                        <td style="width:50%">
                            {% if tc.notifyAuthenticate == True %}
                            {% if tc.notifySavePwd == True %}
                            <input type="checkbox" id="notifysavepwd" name="notifysavepwd" value="1" checked>
                            {% else %}
                            <input type="checkbox" id="notifysavepwd" name="notifysavepwd" value="1">
                            {% endif %}
                            {% else %}
                            <input type="checkbox" id="notifysavepwd" name="notifysavepwd" value="1" disabled>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Full path to credentials file.<br>
                                Make sure that the file is securely protected.
                            </span>
                            <label for="notifypwdpath">Credentials File Path:</label>
                        </td>
                        <td style="width:50%">
                            {% if tc.notifyAuthenticate == True %}
                            <input style="width: 100%" type="text" id="notifypwdpath" name="notifypwdpath" value="{{ tc.notifyPwdPath }}">
                            {% else %}
                            <input style="width: 100%" type="text" id="notifypwdpath" name="notifypwdpath" value="{{ tc.notifyPwdPath }}" disabled>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 50%;">&nbsp;</td>
                        <td style="width: 50%;">&nbsp;</td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Sender Address
                            </span>
                            <label for="notifyfrom">From:</label>
                        </td>
                        <td style="width:50%">
                            <input style="width: 100%" type="email" id="notifyfrom" name="notifyfrom" value="{{ tc.notifyFrom }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Receipient Address
                            </span>
                            <label for="notifyto">To:</label>
                        </td>
                        <td style="width:50%">
                            <input style="width: 100%" type="email" id="notifyto" name="notifyto" value="{{ tc.notifyTo }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Message Subject
                            </span>
                            <label for="notifysubject">Subject:</label>
                        </td>
                        <td style="width:50%">
                            <input style="width: 100%" type="text" id="notifysubject" name="notifysubject" value="{{ tc.notifySubject }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                The amount of time to wait before another notification can send.<br>
                                Should be a multiple of the detection pause to be effective.
                            </span>
                            <label for="notifypause">Notification Cooldown:</label>
                        </td>
                        <td style="width:50%">
                            <input type="number" id="notifypause" name="notifypause" min="0" max="999999" step="1" value="{{ tc.notifyPause }}">
                        </td>
                    </tr>
                    {% if sc.noCamera == False %}
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Activate to include the recorded video in the message.
                            </span>
                            <label for="notifyincludevideo">Include Video:</label>
                        </td>
                        <td style="width:50%">
                            {% if tc.notifyIncludeVideo == True %}
                            <input type="checkbox" id="notifyincludevideo" name="notifyincludevideo" value="1" checked>
                            {% else %}
                            <input type="checkbox" id="notifyincludevideo" name="notifyincludevideo" value="1">
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Enable this to send one, or multiple images in the message.
                            </span>
                            <label for="notifyincludephoto">Include Photos:</label>
                        </td>
                        <td style="width:50%">
                            {% if tc.notifyIncludePhoto == True %}
                            <input type="checkbox" id="notifyincludephoto" name="notifyincludephoto" value="1" checked>
                            {% else %}
                            <input type="checkbox" id="notifyincludephoto" name="notifyincludephoto" value="1">
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                </table>
                <p style="margin-bottom: 0"></p>
                <input class="w3-button w3-black" type="submit" value="Submit">
            </form>
        </div>
    </div>
    {% if sc.lastTriggerTab == "trgevents" %}
    <div id="trgevents" class="triggergroup">
    {% else %}
    <div id="trgevents" class="triggergroup" style="display:none">
    {% endif %}
        <div class="w3-container" style="padding-left: 0;">
            <div class="w3-twothird">
                <p style="margin-top: 0px; margin-bottom:0px">&nbsp</p>
                <div class="w3-bar">
                    <div style="display:inline-block">
                        <a href="{{ url_for('trigger.prev_month') }}" class="w3-button w3-sand">&laquo;</a>
                        <a href="{{ url_for('trigger.prev_day') }}" class="w3-button w3-sand">&lt</a>
                        <form style="display:inline-block" id="setevstartdate" method="post" action="{{ url_for('trigger.set_date') }}">
                            <input style="width:100%" type="date" onchange="dosubmit('setevstartdate')" id="evstartdate" name="evstartdate" value="{{ tc.evStartDateStr }}">
                        </form>
                        <a href="{{ url_for('trigger.next_day') }}" class="w3-button w3-sand">&gt</a>
                        <a href="{{ url_for('trigger.next_month') }}" class="w3-button w3-sand">&raquo;</a>
                    </div>
                    <div style="display:inline-block">
                        <p style="display:inline-block">&nbsp&nbsp&nbsp</p>
                        <a href="{{ url_for('trigger.prev_hor') }}" class="w3-button w3-sand">&laquo;</a>
                        <a href="{{ url_for('trigger.prev_quarter') }}" class="w3-button w3-sand">&lt</a>
                        <form style="display:inline-block" id="setevstarttime" method="post" action="{{ url_for('trigger.set_time') }}">
                            <input style="width:100%" type="time" onchange="dosubmit('setevstarttime')" id="evstarttime" name="evstarttime" value="{{ tc.evStartTimeStr }}">
                        </form>
                        <a href="{{ url_for('trigger.next_quarter') }}" class="w3-button w3-sand">&gt</a>
                        <a href="{{ url_for('trigger.next_hour') }}" class="w3-button w3-sand">&raquo;</a>
                    </div>
                    <div style="display:inline-block; border-left: 20px">
                        <form style="display:inline-block" id="setevstartnow" method="post" action="{{ url_for('trigger.events_now') }}">
                            <input class="w3-button w3-sand" type="submit" value="Now">
                        </form>
                    </div>
                </div>
            </div>
            <div class="w3-third">
                <table style="width:100%;">
                    <tr>
                        <td style="height: 15px;">

                        </td>
                    </tr>
                    <tr>
                        <td style="width: 5%;">
                            <form style="display:inline-block" id="evincludevideofrm" method="post" action="{{ url_for('trigger.event_include_video') }}">
                                {% if tc.evIncludeVideo == True %}
                                <input type="checkbox" id="evincludevideo" name="evincludevideo" onchange="dosubmit('evincludevideofrm')" value="1" checked>
                                {% else %}
                                <input type="checkbox" id="evincludevideo" name="evincludevideo" onchange="dosubmit('evincludevideofrm')" value="0">
                                {% endif %}
                            </form>
                        </td>
                        <td style="width: 35%;">
                            <label for="evincludevideo">Include Videos</label>
                        </td>
                        <td rowspan="2" style="width: 60%;">
                            <div class="w3-right">
                                <form style="display:inline-block" method="post" action="{{ url_for('trigger.do_refresh') }}">
                                    <input style="display:inline-block" class="w3-button w3-green w3-round-xxlarge" type="submit" value="Refresh">
                                </form>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 5%;">
                            <form style="display:inline-block" id="evincludephotofrm" method="post" action="{{ url_for('trigger.event_include_photo') }}">
                                {% if tc.evIncludePhoto == True %}
                                <input type="checkbox" id="evincludephoto" name="evincludephoto" onchange="dosubmit('evincludephotofrm')" value="1" checked>
                                {% else %}
                                <input type="checkbox" id="evincludephoto" name="evincludephoto" onchange="dosubmit('evincludephotofrm')" value="0">
                                {% endif %}
                            </form>
                        </td>
                        <td style="width: 35%;">
                            <label for="evincludephoto">Include Photos</label>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <hr>
        <div class="w3-container" style="padding-left: 0;">
            <div class="w3-third">
                <div style="height:1000px; overflow: auto">
                    <table class="w3-table w3-bordered">
                        {% for ev in tc.eventList %}
                        {% set event = ev.event %}
                        <tr>
                            <td style="width:50%;">
                                <div class="w3-card-4" style="width:100%;">
                                    <header class="w3-container w3-red">
                                        <h5 style="margin-top: 0;margin-bottom:0">{{ event.type }}</h5>
                                    </header>
                                    <div class="w3-container">
                                        <p style="margin-top: 0;margin-bottom:0">{{ event.date }}</p>
                                        <p style="margin-top: 0;margin-bottom:0">{{ event.time }}</p>
                                        <p style="margin-top: 0;margin-bottom:0">{{ event.trigger }}</p>
                                        <p style="margin-top: 0;margin-bottom:0">{{ event.triggertype }}</p>
                                        {% set triggerparams = event.triggerparam %}
                                        {% for key, val in triggerparams.items() %}
                                        <p style="margin-top: 0;margin-bottom:0">{{ key }}:{{ val }}</p>
                                        {% endfor %}
                                    </div>
                                </div>
                            </td>
                            {% if tc.evIncludeVideo %}
                            {% set video = ev.video %}
                            {% if (video|length > 0) and (video.photo != None) %}
                            <td style="width:50%;">
                                <div class="w3-card-4" style="width:100%">
                                    {% set urlMini=url_for('static', filename='events/' + video.photo) %}
                                    {% set urlDetail=url_for('static', filename='events/' + video.filename) %}
                                    <img src="{{ urlMini }}" 
                                         alt="{{ video.filename }}" 
                                         style="width:100%"
                                         onclick="showDetail('video', '{{ urlDetail }}', 'detailphoto', '{{ video.filename }}', '{{ video.filename }}')"
                                    >
                                    <div class="w3-container w3-center">
                                        <p style="margin-top: 0;margin-bottom:0">{{ video.time }}&nbsp;&nbsp;{{ video.duration }} sec</p>
                                    </div>
                                </div>
                            </td>
                            {% else %}
                            {% if tc.evIncludePhoto %}
                            {% set photos = ev.photos %}
                            {% if photos|length > 0 %}
                            {% set photo = photos[0] %}
                            <td style="width:50%;">
                                <div class="w3-card-4" style="width:100%">
                                    {% set urlMini=url_for('static', filename='events/' + photo.filename) %}
                                    {% set urlDetail=url_for('static', filename='events/' + photo.filename) %}
                                    <img src="{{ urlMini }}" 
                                         alt="{{ photo.filename }}" 
                                         style="width:100%"
                                         onclick="showDetail('photo', '{{ urlDetail }}', 'detailphoto', '{{ photo.filename }}', '{{ photo.filename }}')"
                                    >
                                    <div class="w3-container w3-center">
                                        <p style="margin-top: 0;margin-bottom:0">{{ photo.time }}</p>
                                    </div>
                                </div>
                            </td>
                            {% endif %}
                            {% endif %}
                            {% endif %}
                            {% else %}
                            {% if tc.evIncludePhoto %}
                            {% set photos = ev.photos %}
                            {% if photos|length > 0 %}
                            {% set photo = photos[0] %}
                            <td style="width:50%;">
                                <div class="w3-card-4" style="width:100%">
                                    {% set urlMini=url_for('static', filename='events/' + photo.filename) %}
                                    {% set urlDetail=url_for('static', filename='events/' + photo.filename) %}
                                    <img src="{{ urlMini }}" 
                                         alt="{{ photo.filename }}" 
                                         style="width:100%"
                                         onclick="showDetail('photo', '{{ urlDetail }}', 'detailphoto', '{{ photo.filename }}', '{{ photo.filename }}')"
                                    >
                                    <div class="w3-container w3-center">
                                        <p style="margin-top: 0;margin-bottom:0">{{ photo.time }}</p>
                                    </div>
                                </div>
                            </td>
                            {% endif %}
                            {% endif %}
                            {% endif %}
                        </tr>
                        {% if tc.evIncludePhoto %}
                        {% set photos = ev.photos %}
                        {% if photos|length > 0 %}
                        {% for photo in photos%}
                        {% if loop.index > 1 %}
                        <tr>
                            <td>
                            </td>
                            <td style="width:50%;">
                                <div class="w3-card-4" style="width:100%">
                                    {% set urlMini=url_for('static', filename='events/' + photo.filename) %}
                                    {% set urlDetail=url_for('static', filename='events/' + photo.filename) %}
                                    <img src="{{ urlMini }}" alt="{{ photo.filename }}" style="width:100%"
                                        onclick="showDetail('photo', '{{ urlDetail }}', 'detailphoto', '{{ photo.filename }}', '{{ photo.filename }}')">
                                    <div class="w3-container w3-center">
                                        <p style="margin-top: 0;margin-bottom:0">{{ photo.time }}</p>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                        {% endif %}
                        {% endfor %}
                    </table>
                </div>
            </div>
            <div class="w3-twothird">
                <!-- Detail-->
                <div id="detailphoto" class="w3-container w3-center">
                </div>
            </div>
        </div>
    </div>
    {% if sc.lastTriggerTab == "trgcalendar" %}
    <div id="trgcalendar" class="triggergroup">
    {% else %}
    <div id="trgcalendar" class="triggergroup" style="display:none">
    {% endif %}
        <div class="w3-container" style="padding-left: 0;">
            <div class="w3-twothird">
                <p style="margin-top: 0px; margin-bottom:0px">&nbsp</p>
                <div class="w3-bar">
                    <div style="display:inline-block">
                        <a href="{{ url_for('trigger.prev_cal_month') }}" class="w3-button w3-sand">&lt</a>
                        <form style="display:inline-block" id="setcalmonthfrm" method="post" action="{{ url_for('trigger.set_cal_month') }}">
                            <input style="width:100%" type="date" onchange="dosubmit('setcalmonthfrm')" id="setcalmonth" name="setcalmonth" value="{{ tc.calStartDateStr }}">
                        </form>
                        <a href="{{ url_for('trigger.next_cal_month') }}" class="w3-button w3-sand">&gt</a>
                    </div>
                    <div style="display:inline-block; border-left: 20px">
                        <form style="display:inline-block" id="setcalstartnow" method="post" action="{{ url_for('trigger.calendar_now') }}">
                            <input class="w3-button w3-sand" type="submit" value="Now">
                        </form>
                    </div>
                </div>
            </div>
            <div class="w3-third">
                <table style="width:100%;">
                    <tr>
                        <td style="height: 15px;"></td>
                    </tr>
                    <tr>
                        <td style="width: 100%;">
                            <div class="w3-right">
                                <form style="display:inline-block" id="dodownloadlog" method="post" action="{{ url_for('trigger.do_download_log') }}">
                                    <input class="w3-button w3-green w3-round-xxlarge" style="display:inline-block; width: 150px" type="submit"
                                        value="Download Log">
                                </form>
                                <form style="display:inline-block" id="docleanupevents" method="post" action="{{ url_for('trigger.do_cleanup') }}">
                                    <input class="w3-button w3-black w3-round-xxlarge" style="display:inline-block; width: 100px" type="submit" 
                                        onclick="confirmCleanup('docleanupevents', '{{ tc.retentionPeriodStr}}')" value="Cleanup">
                                </form>
                                <form style="display:inline-block" method="post" action="{{ url_for('trigger.do_refresh_calendar') }}">
                                    <input style="display:inline-block" class="w3-button w3-green w3-round-xxlarge" type="submit" value="Refresh">
                                </form>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 5%;"></td>
                        <td style="width: 35%;"></td>
                    </tr>
                </table>
            </div>
        </div>
        <hr>
        <div class="w3-container" style="padding-left: 0;">
            <h2 style="margin-left: 30px"> Events for {{ tc.calendarMonthStr}}</h2>
            <!-- Invisible input field for selected day -->
            <form style="display:none;" id="selecteddayfrm" method="post" action="{{ url_for('trigger.calendar_goto') }}">
                <input style="display:none;" type="text" id="selectedday" name="selectedday" value="">
            </form>
            <table>
                <tr>
                    <td style="width:30px"></td>
                    <td style="width:50px">Mon</td>
                    <td style="width:50px">Tue</td>
                    <td style="width:50px">Wed</td>
                    <td style="width:50px">Thu</td>
                    <td style="width:50px">Fri</td>
                    <td style="width:50px">Sat</td>
                    <td style="width:50px">Sun</td>
                </tr>
                {% for week in tc.calendar%}
                <tr>
                    <td>{{ week.week }}</td>
                    {% set weekdays = week.weekdays %}
                    {% for day in weekdays %}
                    {% set data = day.data %}
                    <td class="w3-border">
                        <div class="w3-panel w3-light-grey" style="margin-top: 0px; margin-bottom: 0px">
                            <p style="margin-top: 8px; margin-bottom: 8px">{{ day.day }}</p>
                        </div>
                        {% if data.nrevents > 0 %}
                        <div class="w3-panel w3-border-red w3-pale-red" style="margin-top: 0px; margin-bottom: 0px" onclick="goToDay('{{ day.date }}')">
                            <p>{{ data.nrevents }}</p>
                        </div>
                        {% else %}
                        <div class="w3-panel" style="margin-top: 0px; margin-bottom: 0px">
                        <p>&nbsp;</p>
                        </div>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>
    <script>
        var triggerDelete = 0;
        var actionDelete = 0;
        var activeTab = "";

        function openTriggerTab(trgTabName, trgTabButton) {
            var i;
            var x = document.getElementsByClassName("triggergroup");
            for (i = 0; i < x.length; i++) {
                x[i].style.display = "none";
            }
            document.getElementById(trgTabName).style.display = "block";

            var b = document.getElementsByClassName("triggermenu");
            for (i = 0; i < b.length; i++) {
                b[i].classList = "w3-bar-item w3-button triggermenu";
            }
            document.getElementById(trgTabButton).classList = "w3-bar-item w3-button triggermenu w3-light-green";

            activeTab = trgTabName

            if ('{{ sc.isLiveStream }}' == "True") {
                if (trgTabName == "trgmotion") {
                    removeRoiWindowCanvas()
                    drawRoiWindow('useroi', '{{ sc.scalerCropLiveView }}')
                    drawAllRoiWindows();
                } else {
                    removeRoiWindowCanvas()
                }
            } else {
                removeRoiWindowCanvas()
            }
        }

        function dosubmit(form) {
            document.getElementById(form).submit();
        }

        function showDetail(type, url, tgtPhoto, file, name) {
            var tgtP = document.getElementById(tgtPhoto);
            var dType = type
            if (file.substring(19) == ".GIF"){
                type = "gif"
            }

            if (type != "video") {
                tag = "<img style='width: 100%; height: 900px; object-fit: scale-down; cursor:pointer'"
                tag = tag + " src='" + url + "'"
                tag = tag + " class='w3-border w3-padding'"
                tag = tag + " alt='" + name + "'"
                tag = tag + " onclick='openMedia(this.src)'"
                tag = tag + ">"
                tag = tag + "<p>" + file + "</p>"
                //console.log("tag:", tag)
                tgtP.innerHTML = tag
            } else {
                tag =       "<div class='video-wrapper'>"
                tag = tag + "   <video style='width: 100%; height: 900px; object-fit: scale-down'"
                tag = tag + "          class='w3-border w3-padding'"
                tag = tag + "          controls>"
                tag = tag + "       <source src='" + url + "'" + " type='video/mp4'>"
                tag = tag + "       Your browser does not support mp4 video"
                tag = tag + "   </video>"
                tag = tag + "   <div class='open-overlay'"
                tag = tag + "        onclick='openVideo(\"" + url + "\")'"
                tag = tag + "        title='Open in new window'>"
                tag = tag + "    </div>"
                tag = tag + " </div>"
                tag = tag + "<p>" + file + "</p>"
                //console.log("tag:", tag)
                tgtP.innerHTML = tag
            }
        }

        function confirmCleanup(form, retention) {
            if (confirm("Do you want to delete all events older than " + retention + " days?")) {
                document.getElementById(form).method = "post";
                document.getElementById(form).submit();
            } else {
                document.getElementById(form).method = "get";
            }
        }

        function goToDay(date) {
            var datefield = document.getElementById("selectedday");
            datefield.value = date
            document.getElementById("selecteddayfrm").submit();
        }

        function motionDetectionAlgoChanged() {
            // Activate / deactivate fields depending on algorithm
            var src = document.getElementById("motiondetectionalgo");
            var val = src.value;
            if (val == "1"){
                // Mean Square Threshold
                document.getElementById("msdthreshold").disabled = false;
                document.getElementById("bboxthreshold").disabled = true;
                document.getElementById("nmsthreshold").disabled = true;
                document.getElementById("motionthreshold").disabled = true;
                document.getElementById("backsubmodel").disabled = true;
                document.getElementById("videobboxes").disabled = true;
            }
            if (val == "2"){
                // Frame Differencing
                document.getElementById("msdthreshold").disabled = true;
                document.getElementById("bboxthreshold").disabled = false;
                document.getElementById("nmsthreshold").disabled = false;
                document.getElementById("motionthreshold").disabled = true;
                document.getElementById("backsubmodel").disabled = true;
                document.getElementById("videobboxes").disabled = false;
            }
            if (val == "3"){
                // Optical Flow
                document.getElementById("msdthreshold").disabled = true;
                document.getElementById("bboxthreshold").disabled = false;
                document.getElementById("nmsthreshold").disabled = false;
                document.getElementById("motionthreshold").disabled = false;
                document.getElementById("backsubmodel").disabled = true;
                document.getElementById("videobboxes").disabled = false;
            }
            if (val == "4"){
                // Background Subtraction
                document.getElementById("msdthreshold").disabled = true;
                document.getElementById("bboxthreshold").disabled = false;
                document.getElementById("nmsthreshold").disabled = false;
                document.getElementById("motionthreshold").disabled = true;
                document.getElementById("backsubmodel").disabled = false;
                document.getElementById("videobboxes").disabled = false;
            }            
        }

        function mailServerAuthenicationChanged() {
            /*  The function enables/disables user/password on Notification ab
            */
            var cb = document.getElementById("notifyauthenticate");
            if (cb.checked == true) {
                document.getElementById("notifyuser").disabled = false;
                document.getElementById("notifypassword").disabled = false;
                document.getElementById("notifysavepwd").disabled = false;
                document.getElementById("notifypwdpath").disabled = false;
            } else {
                document.getElementById("notifyuser").disabled = true;
                document.getElementById("notifypassword").disabled = true;
                document.getElementById("notifysavepwd").disabled = true;
                document.getElementById("notifypwdpath").disabled = true;
            }
        }
        function onlineHelp() {
            window.open("{{ sc.getBaseHelpUrl() }}/Trigger/");
        }
        function dosubmitTriggerSource(){
            td = document.getElementById("triggerdevice");
            td.value = "";
            td.disabled = true;
            tt = document.getElementById("triggerdevicetype");
            if (tt) {
                tt.value = "";
                tt.display = "none";
            }
            tu = document.getElementById("triggerdevicedocurl");
            if (tu) {
                tu.value = "";
                tu.display = "none";
            }
            te = document.getElementById("triggerevent");
            te.value = "";
            te.disabled = true;
            tt = document.getElementById("triggereventsettingsarea");
            tt.display = "none";
            document.getElementById("newtriggerform").submit();
        }
        function dosubmitTriggerDevice(){
            te = document.getElementById("triggerevent");
            te.value = "";
            te.disabled = true;
            tt = document.getElementById("triggereventsettingsarea");
            tt.display = "none";
            document.getElementById("newtriggerform").submit();
        }
        function dosubmitTriggerEvent(){
            tt = document.getElementById("triggereventsettingsarea");
            tt.display = "none";
            document.getElementById("newtriggerform").submit();
        }
        function dosubmitActionSource(){
            td = document.getElementById("actiondevice");
            td.value = "";
            td.disabled = true;
            tt = document.getElementById("actiondevicetype");
            if (tt) {
                tt.value = "";
                tt.display = "none";
            }
            tu = document.getElementById("devicedocurl");
            if (tu) {
                tu.innerHTML = "";
                tu.display = "none";
            }
            te = document.getElementById("actionmethod");
            te.value = "";
            te.disabled = true;
            tt = document.getElementById("actiontargetsettingsarea");
            tt.display = "none";
            document.getElementById("newactionform").submit();
        }
        function dosubmitActionDevice(){
            te = document.getElementById("actionmethod");
            te.value = "";
            te.disabled = true;
            tt = document.getElementById("actiontargetsettingsarea");
            tt.display = "none";
            document.getElementById("newactionform").submit();
        }
        function dosubmitActionMethod(){
            tt = document.getElementById("actiontargetsettingsarea");
            tt.display = "none";
            document.getElementById("newactionform").submit();
        }
        function countTriggerDelete(id){
            cb = document.getElementById(id);
            if (cb.checked == true){
                triggerDelete += 1;
            } else {
                triggerDelete -= 1;
            }
            //console.log("triggerDelete=", triggerDelete, " checked=", cb.checked);
        }
        function confirmDeleteTriggers(form) {
            if (triggerDelete > 0){
                if (confirm("Do you want to delete the selected triggers?")) {
                    document.getElementById(form).method = "post";
                    document.getElementById(form).submit();
                } else {
                    document.getElementById(form).method = "get";
                }
            }
        }
        function countActionDelete(id){
            cb = document.getElementById(id);
            if (cb.checked == true){
                actionDelete += 1;
            } else {
                actionDelete -= 1;
            }
            //console.log("triggerDelete=", triggerDelete, " checked=", cb.checked);
        }
        function confirmDeleteActions(form) {
            if (actionDelete > 0){
                if (confirm("Do you want to delete the selected actions?")) {
                    document.getElementById(form).method = "post";
                    document.getElementById(form).submit();
                } else {
                    document.getElementById(form).method = "get";
                }
            }
        }
    </script>
    <script>
        function enableRegionOfInterest() {
            /*  enable tha ROI/RONI text fields to allow Flask to request its content
            */
            document.getElementById("regionofinterest").disabled = false
            document.getElementById("regionofnointerest").disabled = false
        }
    </script>
    <script>
        function showRoiWindows(tabSelected, liveStreamActive, camRef) {
            /*  If Trigger/Motion tab is selected, show th ROI/RONI Windows
                if ROI/RONI drawing is enabled
                This function is called after the page finished loading
                in order to assure initial visibility of ROI windows
                tabSelected:       name of the initially selected tab
                liveStreamActive: "True"/"False" if live stream is active
                camRef:            Current scaler crop
            */
            //console.log("showRoiWindows - tabselected:", tabSelected, " liveStreamActive:", liveStreamActive, " activeTab:", activeTab)

            // We need to handle the case where a specific tab has been selected without posting.
            // In this case, tabSelected is not the actually selected tab
            // but the tab on which the last post has been made

            currentTab = tabSelected
            if (activeTab != "") {
                currentTab = activeTab;
            }

            if (currentTab == "trgmotion") {
                // First remove the existing canvas, which is required for resize
                removeRoiWindow();
                if (liveStreamActive == "True") {
                    drawRoiWindow('useroi', camRef);
                    drawAllRoiWindows();
                }
            }
        }
        function switchRoiType(id1, id2) {
            /*  Switch between ROI and RONI drawing mode
            */
            var elmt1 = document.getElementById(id1);
            var elmt2 = document.getElementById(id2);
            if (elmt1.checked == true) {
                elmt2.checked = false;
            } else {
                elmt2.checked = true;
            }
            setRoiUseCase();
        }
    </script>
    <script>
        var useCase;
        var roiColor = "green";
        var doDraw;
        var roiWinTarget;
        var roiCanvas;
        var roiCanvasCtx;
        var roiCanvasOffsetX;
        var roiCanvasOffsetY;
        var mouseIsDown;
        var mouseStartX;
        var mouseStartY;
        var camXOffset;
        var camYOffset;
        var camWidth;
        var camHeight;
        var winXOffset;
        var winYOffset;
        var winWidth;
        var winHeight;

        function removeRoiWindowCanvas(){
            /*  Removes the canvas for ROI Windows
            */
            var cnvEl = document.getElementById("canvasforroi");
            if (cnvEl) {
                // Unregister event listeners
                document.getElementById('canvasforroi').removeEventListener('mousedown', function (e) {
                    handleMouseDown(e);
                });
                document.getElementById('canvasforroi').removeEventListener('mousemove', function (e) {
                    handleMouseMove(e);
                });
                document.getElementById('canvasforroi').removeEventListener('mouseup', function (e) {
                    handleMouseUp(e);
                });
                document.getElementById('canvasforroi').removeEventListener('mouseout', function (e) {
                    handleMouseOut(e);
                });   
                document.getElementById('canvasforroi').removeEventListener('touchstart', function (e) {
                    handleTouchStart(e);
                });
                document.getElementById('canvasforroi').removeEventListener('touchmove', function (e) {
                    handleTouchMove(e);
                }, true);
                document.getElementById('canvasforroi').removeEventListener('touchend', function (e) {
                    handleMouseUp(e);
                });
                document.getElementById('canvasforroi').removeEventListener('touchcancel', function (e) {
                    handleMouseOut(e);
                });
                roiCanvas = null;
                roiCanvasCtx = null;
            }
        }

        function parseWindows(wins) {
            /*  Parses the tuple of one or multiple rectangles
                ((x,x,x,x),(x,x,x,x))
                and returns an array of rectangles as strings
            */
            var resa = [];
            var cnt = 0;
            if (wins[0] == "(") {
                var wns = wins.slice(1);
                if (wns[wns.length - 1] == ")") {
                    wns = wns.slice(0, wns.length - 1);
                    while (wns.length > 0) {
                        var i = wns.indexOf(")");
                        if ( i > 0) {
                            wn = wns.slice(0, i + 1);
                            resa[cnt] = wn;
                            cnt = cnt + 1;
                            if (i < wns.length) {
                                wns = wns.slice(i + 2);
                            } else {
                                wns = "";
                            }
                        } else {
                            wns = "";
                        }
                    }
                }
            }
            return resa;
        }

        function parseWindow(wins) {
            /*  Parses the rectangle
                (x,x,x,x)
                and returns an array of one rectangle as string
            */
            var resa = [] 
            resa[0]= wins;
            return resa;
        }

        function drawCnvWindow(win, index, winlist) {
            /*  Draw the given window on the canvas
            */
            //console.log("drawCnvWindow win:", win);

            // Parse the window spec for the ROI Window
            var roiWina = parseRectTuple(win);
            var roiWinXOffset = roiWina[0];
            var roiWinYOffset = roiWina[1];
            var roiWinWidth = roiWina[2];
            var roiWinHeight = roiWina[3];
            //console.log("cnv: ", roiCanvasOffsetX, roiCanvasOffsetY, roiCanvas.width, roiCanvas.height)
            //console.log("cam: ", camXOffset, camYOffset, camWidth, camHeight)
            //console.log("roiw: ", roiWinXOffset, roiWinYOffset, roiWinWidth, roiWinHeight)

            // Scale to canvas
            var winWidth = Math.round(roiWinWidth * roiCanvas.width / camWidth);
            var winHeight = Math.round(roiWinHeight * roiCanvas.height / camHeight);
            var winXOffset = Math.round((roiWinXOffset - camXOffset) * roiCanvas.width / camWidth);
            var winYOffset = Math.round((roiWinYOffset - camYOffset) * roiCanvas.height / camHeight);
            //console.log("win: ", winXOffset, winYOffset, winWidth, winHeight)

            // Draw
            roiCanvasCtx.strokeRect(winXOffset, winYOffset, winWidth, winHeight);
        }

        function drawFilledCnvWindow(win, index, winlist) {
            /*  Draw the given window on the canvas
            */
            //console.log("drawFilledCnvWindow win:", win);

            // Parse the window spec for the ROI Window
            var roiWina = parseRectTuple(win);
            var roiWinXOffset = roiWina[0];
            var roiWinYOffset = roiWina[1];
            var roiWinWidth = roiWina[2];
            var roiWinHeight = roiWina[3];
            //console.log("cnv: ", roiCanvasOffsetX, roiCanvasOffsetY, roiCanvas.width, roiCanvas.height)
            //console.log("cam: ", camXOffset, camYOffset, camWidth, camHeight)
            //console.log("roiw: ", roiWinXOffset, roiWinYOffset, roiWinWidth, roiWinHeight)

            // Scale to canvas
            var winWidth = Math.round(roiWinWidth * roiCanvas.width / camWidth);
            var winHeight = Math.round(roiWinHeight * roiCanvas.height / camHeight);
            var winXOffset = Math.round((roiWinXOffset - camXOffset) * roiCanvas.width / camWidth);
            var winYOffset = Math.round((roiWinYOffset - camYOffset) * roiCanvas.height / camHeight);
            //console.log("win: ", winXOffset, winYOffset, winWidth, winHeight)

            // Draw
            roiCanvasCtx.fillRect(winXOffset, winYOffset, winWidth, winHeight);
        }

        function drawAllRoiWindows() {
            /*  Parses the windows entry in the target element
                and draws all resulting windows
            */
            //console.log("drawAllRoiWindows)

            // Clear canvas
            if (roiCanvasCtx) {
                roiCanvasCtx.clearRect(0, 0, roiCanvas.width, roiCanvas.height);
            }

            // Regions of interest
            var roiWinlist = [];
            var roiWindows = document.getElementById("regionofinterest").value;
            //console.log("roiWindows:", roiWindows)
            var roiWinlist = parseWindows(roiWindows)
            //console.log("roiWinlist:", roiWinlist)
            if (roiCanvasCtx) {
                // Draw all windows
                roiCanvasCtx.strokeStyle = "green";
                roiCanvasCtx.lineWidth = 2;
                roiWinlist.forEach(drawCnvWindow)
            }

            // Regions of NO interest
            var roniWinlist = [];
            var roniWindows = document.getElementById("regionofnointerest").value;
            //console.log("roniWindows:", roniWindows)
            var roniWinlist = parseWindows(roniWindows)
            //console.log("roniWinlist:", roniWinlist)
            if (roiCanvasCtx) {
                // Draw all windows
                roiCanvasCtx.fillStyle = "blue";
                roiCanvasCtx.lineWidth = 2;
                roniWinlist.forEach(drawFilledCnvWindow)
            }
        }

        function addNewRoiWindow() {
            /*  add a new ROI Window to the tuple of windows available in the target element
            */
            // Scale
            //console.log('addNewRoiWindow');
            //console.log("cnv: ", roiCanvasOffsetX, roiCanvasOffsetY, roiCanvas.width, roiCanvas.height)
            //console.log("cam: ", camXOffset, camYOffset, camWidth, camHeight)
            //console.log("win: ", winXOffset, winYOffset, winWidth, winHeight)
            var roiWinWidth = Math.round(winWidth * camWidth / roiCanvas.width);
            var roiWinHeight = Math.round(winHeight * camHeight / roiCanvas.height);
            var roiWinXOffset = Math.round(camXOffset + winXOffset * camWidth / roiCanvas.width);
            var roiWinYOffset = Math.round(camYOffset + winYOffset * camHeight / roiCanvas.height);
            var roiWindows = roiWinTarget.value;
            //console.log("roiWindows old:", roiWindows);

            // Concatenate to roiWindows
            roiWindows = roiWindows.slice(0, roiWindows.length - 1);
            if (roiWindows.length > 1) {
                roiWindows = roiWindows + ","
            }
            roiWindows = roiWindows 
                + "(" 
                + roiWinXOffset.toString() + "," 
                + roiWinYOffset.toString() + ","
                + roiWinWidth.toString() + ","
                + roiWinHeight.toString()
                + ")";
            roiWindows = roiWindows + ")";
            //console.log("roiWindows new:", roiWindows);

            // Store in target
            roiWinTarget.value = roiWindows;
        }

        function handleMouseDown(e) {
            /*  In case of mouse down, memorize point as start of rectangle
            */
            //console.log('handleMouseDown')
            //console.log(e)
            e.preventDefault();
            e.stopPropagation();

            // save the starting x/y of the rectangle
            mouseStartX = parseInt(e.clientX - roiCanvasOffsetX);
            mouseStartY = parseInt(e.clientY - roiCanvasOffsetY);

            // set a flag indicating the drag has begun
            mouseIsDown = true;
        }

        function handleTouchStart(e) {
            /*  In case of mouse down, memorize point as start of rectangle
            */
            //console.log('handleMouseDown')
            //console.log(e)
            e.preventDefault();
            e.stopPropagation();

            // Always get the correct offset within the canvas
            const rect = roiCanvas.getBoundingClientRect();
            const touch = e.touches[0];

            mouseStartX = touch.clientX - rect.left;
            mouseStartY = touch.clientY - rect.top;

            // set a flag indicating the drag has begun
            mouseIsDown = true;
        }

        function handleMouseUp(e) {
            /*  In case of mouse up, register end of drawing
            */
            //console.log('handleMouseUp');
            //console.log(e)
            e.preventDefault();
            e.stopPropagation();

            // the drag is over, clear the dragging flag
            mouseIsDown = false;

            // Add new window
            addNewRoiWindow();
        }

        function handleMouseOut(e) {
            /*  In case of mouse leaving the canvas,
                Draw all windows
            */
            //console.log('handleMouseOut')
            //console.log(e)
            e.preventDefault();
            e.stopPropagation();

            // the drag is over, clear the dragging flag
            mouseIsDown = false;
            // Draw all windows
            drawAllRoiWindows();
        }

        function handleMouseMove(e) {
            /*  While mouse is moving with mouse down,
                Clear canvas from previous rectangle
                and draw rectangle with new coordinates.
                Memorize rectangla parameters.
            */
            //console.log('handleMouseMove')
            //console.log(e)
            e.preventDefault();
            e.stopPropagation();

            // if we're not dragging, just return
            if (!mouseIsDown) {
                return;
            }

            // get the current mouse position
            mouseX = parseInt(e.clientX - roiCanvasOffsetX);
            mouseY = parseInt(e.clientY - roiCanvasOffsetY);

            // clear the canvas
            roiCanvasCtx.clearRect(0, 0, roiCanvas.width, roiCanvas.height);

            // calculate the rectangle width/height based
            // on starting vs current mouse position
            var width = mouseX - mouseStartX;
            var height = mouseY - mouseStartY;

            // draw a new rect from the start position 
            // to the current mouse position
            if (useCase == "roi") {
                roiCanvasCtx.strokeRect(mouseStartX, mouseStartY, width, height);
            } else {
                roiCanvasCtx.fillRect(mouseStartX, mouseStartY, width, height);
            }
            if (width >= 0) {
                winXOffset = mouseStartX;
                winWidth = width;
            } else {
                winXOffset = mouseX;
                winWidth = -1 * width;
            }
            if (height >= 0) {
                winYOffset = mouseStartY;
                winHeight = height;
            } else {
                winYOffset = mouseY;
                winHeight = -1 * height;
            }
        }

        function handleTouchMove(e) {
            /*  While mouse is moving with mouse down,
                Clear canvas from previous rectangle
                and draw rectangle with new coordinates.
                Memorize rectangla parameters.
            */
            //console.log('handleMouseMove')
            //console.log(e)
            e.preventDefault();
            e.stopPropagation();

            // if we're not dragging, just return
            if (!mouseIsDown) {
                return;
            }

            // get the current mouse position
            // Always get the correct offset within the canvas
            const rect = roiCanvas.getBoundingClientRect();
            const touch = e.touches[0];

            mouseX = touch.clientX - rect.left;
            mouseY = touch.clientY - rect.top;

            // clear the canvas
            roiCanvasCtx.clearRect(0, 0, roiCanvas.width, roiCanvas.height);

            // calculate the rectangle width/height based
            // on starting vs current mouse position
            var width = mouseX - mouseStartX;
            var height = mouseY - mouseStartY;

            // draw a new rect from the start position 
            // to the current mouse position
            if (useCase == "roi") {
                roiCanvasCtx.strokeRect(mouseStartX, mouseStartY, width, height);
            } else {
                roiCanvasCtx.fillRect(mouseStartX, mouseStartY, width, height);
            }
            if (width >= 0) {
                winXOffset = mouseStartX;
                winWidth = width;
            } else {
                winXOffset = mouseX;
                winWidth = -1 * width;
            }
            if (height >= 0) {
                winYOffset = mouseStartY;
                winHeight = height;
            } else {
                winYOffset = mouseY;
                winHeight = -1 * height;
            }
        }

        function parseRectTuple(tuple) {
            /*  Parse a Python tuple for libcamera.Rectangle
                (xOffset, yOffset, width, height)
            */
            resn = [0, 0, 0, 0]
            if (tuple[0] == "(") {
                var tpl = tuple.slice(1)
                if (tpl[tpl.length - 1] == ")") {
                    tpl = tpl.slice(0, tpl.length - 1)
                    var res = tpl.split(",")
                    if (res.length == 4) {
                        resn = [parseInt(res[0]), parseInt(res[1]), parseInt(res[2]), parseInt(res[3])]
                    }
                }
            }
            return resn
        }

        function setRoiUseCase(){
            /*  Set the use case for ROI Windows
                depending on selection of "drawroi" and "drawroni" checkboxes.
            */
            useCase = "roi";
            roiWinTarget = document.getElementById("regionofinterest");
            if (roiCanvasCtx) {
                roiCanvasCtx.strokeStyle = "green";
            }
            var roniEl = document.getElementById("drawroni");
            if (roniEl) {
                if (roniEl.checked == true) {
                    useCase = "roni";
                    roiWinTarget = document.getElementById("regionofnointerest");
                    if (roiCanvasCtx) {
                        roiCanvasCtx.strokeStyle = "blue";
                        roiCanvasCtx.fillStyle = "blue";
                    }
                }
            }
        }

        function clearRoi(){
            /*  Clear the ROI/RONI windows
            */
            roiWinTarget = document.getElementById("regionofinterest");
            roiWinTarget.value = "()";
            roniWinTarget = document.getElementById("regionofnointerest");
            roniWinTarget.value = "()";
        }

        function drawRoiWindow(trg, camRef) {
            /*  Initialize the drawing infrastructure for ROI Windows
                trg: Trigger (checkbox)
                     If checked, canvas and ROI Windows are drawn
                     If unchecked, canvas is removed
                camRef: Scaler crop for Live View as base for scaling
            */
            //console.log("drawRoiWindow trg:", trg, " camRef", camRef);

            setRoiUseCase();

            var ctrlEl = document.getElementById("drawroictrl");
            var photoRoi = document.getElementById("photorois");

            var trgEl = document.getElementById(trg);
            if (trgEl) {
                if (trgEl.checked == true) {
                    doDraw = true;
                    ctrlEl.style.display = "block";
                    photoRoi.disabled = false;
                } else {
                    doDraw = false;
                    ctrlEl.style.display = "none";
                    photoRoi.checked = false;
                    photoRoi.disabled = true;
                }
                //console.log("drawRoiWindow doDraw:", doDraw);
                drawWindow(camRef);
            }
        }

        function syncCanvas() {
            /*  Sync the canvas with the current ROI/RONI windows
            */
            var img = document.getElementById("liveviewforroi");
            var bRect = img.getBoundingClientRect();
            roiCanvas.width = bRect.width;
            roiCanvas.height = bRect.height;
        }

        function drawWindow(camRef) {
            /*  Creates canvas over live view image and allows drawing of ROI Windows
                tgt: Target element taking windows
                camRef: Scaler crop for Live View as base for scaling
            */
            //console.log("drawWindow camRef", camRef);
            // calculate camera crop window params
            var camCrop = parseRectTuple(camRef);
            camXOffset = camCrop[0];
            camYOffset = camCrop[1];
            camWidth = camCrop[2];
            camHeight = camCrop[3];
            //console.log(camXOffset, camYOffset, camWidth, camHeight);

            if (doDraw == true) {
                // Trigger active -> prepare canvas
                var img = document.getElementById("liveviewforroi");
                // Get the canvas
                roiCanvas = document.getElementById('canvasforroi');
                // Position and size the canvas
                var bRect = img.getBoundingClientRect();
                roiCanvas.style.position = "absolute";
                roiCanvas.style.top = 0;
                roiCanvas.style.left = 0;
                roiCanvas.width = bRect.width;
                roiCanvas.height = bRect.height;
                // Set context
                roiCanvasCtx = roiCanvas.getContext("2d");
                roiCanvasCtx.strokeStyle = "green";
                roiCanvasCtx.fillStyle = "blue";
                roiCanvasCtx.lineWidth = 2;
                // Determine canvas position
                liveCanvasOffset = roiCanvas.getBoundingClientRect();
                roiCanvasOffsetX = liveCanvasOffset.left
                roiCanvasOffsetY = liveCanvasOffset.top
                // Initialize mouse down
                mouseIsDown = false;
                // Register event listeners
                document.getElementById('canvasforroi').addEventListener('mousedown', function (e) {
                    handleMouseDown(e);
                });
                document.getElementById('canvasforroi').addEventListener('mousemove', function (e) {
                    handleMouseMove(e);
                });
                document.getElementById('canvasforroi').addEventListener('mouseup', function (e) {
                    handleMouseUp(e);
                });
                document.getElementById('canvasforroi').addEventListener('mouseout', function (e) {
                    handleMouseOut(e);
                });
                document.getElementById('canvasforroi').addEventListener('touchstart', function (e) {
                    handleTouchStart(e);
                });
                document.getElementById('canvasforroi').addEventListener('touchmove', function (e) {
                    handleTouchMove(e);
                }, true);
                document.getElementById('canvasforroi').addEventListener('touchend', function (e) {
                    handleMouseUp(e);
                });
                document.getElementById('canvasforroi').addEventListener('touchcancel', function (e) {
                    handleMouseOut(e);
                });
            } else {
                // Trigger inactive -> destroy canvas and clear ROIWindows
                removeRoiWindow()
                clearRoi();
            }
        }

        function removeRoiWindow() {
            /*  Remove RoiWindow canvas infrastructure
            */
            var cnvEl = document.getElementById("canvasforroi");
            if (cnvEl) {
                // Unregister event listeners
                document.getElementById('canvasforroi').removeEventListener('mousedown', function (e) {
                    handleMouseDown(e);
                });
                document.getElementById('canvasforroi').removeEventListener('mousemove', function (e) {
                    handleMouseMove(e);
                });
                document.getElementById('canvasforroi').removeEventListener('mouseup', function (e) {
                    handleMouseUp(e);
                });
                document.getElementById('canvasforroi').removeEventListener('mouseout', function (e) {
                    handleMouseOut(e);
                });

                document.getElementById('canvasforroi').removeEventListener('touchstart', function (e) {
                    handleTouchStart(e);
                });
                document.getElementById('canvasforroi').removeEventListener('touchmove', function (e) {
                    handleTouchMove(e);
                }, true);
                document.getElementById('canvasforroi').removeEventListener('touchend', function (e) {
                    handleMouseUp(e);
                });
                document.getElementById('canvasforroi').removeEventListener('touchcancel', function (e) {
                    handleMouseOut(e);
                });                
                roiCanvas = null;
                roiCanvasCtx = null;
            }
        }
    </script>
    <style>
        canvas {
            border: 1px solid yellow;
        }
    </style>
    <script>
        function openMedia(src) {
            window.open(
                '/media-viewer?src=' + encodeURIComponent(src),
                '_blank',
                'noopener'
            );
        }

        function openVideo(src) {
            window.open(
                '/media-viewer?type=video&src=' + encodeURIComponent(src),
                '_blank',
                'noopener'
            );
        }
    </script>
{% endblock %}